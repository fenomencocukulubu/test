<!-- /index.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fenomen Çocuk Kulübü • Grup Ders Planlama (tablı)</title>
<style>
  :root{
    --bg:#f6f9fb; --panel:#ffffff; --ink:#0f172a; --muted:#64748b;
    --pri:#14b8a6; --pri-ink:#083c3a; --acc:#6366f1; --warn:#f59e0b; --danger:#ef4444;
    --chip:#e2f5f2; --grid:#e5e7eb; --radius:16px;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial;}
  h1,h2,h3{margin:0 0 .4rem}
  h1{font-size:clamp(20px,3vw,28px);font-weight:800}
  h2{font-size:clamp(18px,2.4vw,22px);font-weight:700}
  h3{font-size:clamp(16px,2vw,18px);font-weight:700}
  /* Uygulama genişliği büyütüldü */
  .app{max-width:1680px;margin:auto;padding:18px}
  .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--pri),#8b5cf6)}
  .brand .title small{color:var(--muted)}
  .content{background:var(--panel);border-radius:var(--radius);box-shadow:0 10px 25px rgba(15,23,42,.06);padding:16px}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--pri);color:#fff;font-weight:700;cursor:pointer}
  .btn.sm{padding:7px 10px;font-size:13px}
  .btn.xs{padding:6px 8px;font-size:12px;border-radius:10px}
  .btn.sec{background:var(--acc)}
  .btn.ghost{background:#e2e8f0;color:#0f172a}
  .btn.warn{background:var(--warn);color:#111827}
  .btn.danger{background:var(--danger)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  input[type=text], input[type=number], select, textarea{
    padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;min-width:220px
  }
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:10px 12px;background:#fff;border-top:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb}
  th{position:sticky;top:0;background:#f8fafc;z-index:1}
  tr{border-radius:10px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);font-weight:600;color:var(--pri-ink)}
  .pill.bad{background:#fee2e2;color:#991b1b}
  .card{background:#fff;border-radius:16px;padding:14px;box-shadow:0 8px 20px rgba(15,23,42,.06);border:1px solid #e5e7eb;overflow:hidden}
  .kgrid{display:grid;gap:6px}
  .kgrid[data-cols]{grid-template-columns:140px repeat(var(--cols), minmax(72px,1fr));}
  .kcell{border:1px dashed var(--grid);min-height:60px;padding:6px;border-radius:10px;background:#fafafa;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;cursor:pointer;white-space:pre-line}
  .kcell.busy{background:#eef2ff;border-color:#c7d2fe}
  .kcell.bad{background:#fee2e2;border-color:#fecaca}
  .kcell.ok{background:#dcfce7;border-color:#bbf7d0}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .legend span{padding:6px 10px;border-radius:20px;background:#f1f5f9}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .wide{width:100%}
  /* Geniş kart dizilimi */
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(560px,1fr));gap:14px}
  .flex{display:flex;gap:10px;align-items:center}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .mini{font-size:12px}
  .mini2{font-size:11px;color:#475569}
  .tag{display:inline-block;background:#f1f5f9;padding:2px 8px;border-radius:999px;margin-left:6px;color:#334155}
  .nowrap{white-space:nowrap}

  /* 1. resim – Öğretmen/Grup müsaitlik kartları genişletildi */
  .avGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(520px,1fr));gap:14px;align-items:stretch}
  .avGrid .card{height:100%;display:flex;flex-direction:column}
  .avGrid .kgrid{flex:1}

  /* Üst sekmeler */
  .tabs{display:flex;gap:6px;border-bottom:1px solid #e5e7eb;margin-bottom:8px}
  .tab{padding:10px 14px;border-radius:10px 10px 0 0;background:#eef2ff;color:#1f2937;cursor:pointer;font-weight:700;user-select:none}
  .tab[aria-selected="true"]{background:#fff;border:1px solid #e5e7eb;border-bottom-color:#fff}
  .tabpanel[hidden]{display:none !important}

  /* Talep sayacı kutucukları */
  .qty{display:inline-flex;align-items:center;border:1px solid #cbd5e1;border-radius:12px;overflow:hidden}
  .qty input{border:0;min-width:56px;text-align:center;padding:8px 10px}
  .qty button{border:0;background:#eef2ff;padding:8px 10px;cursor:pointer}

  /* Yazdırma */
  @media print{
    @page{size:A4;margin:12mm}
    body{background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact}
    .no-print{display:none !important}
    .printable{display:block}
    .print-header{font-weight:900;text-align:center;margin-bottom:6px}
    .print-sub{color:#475569;text-align:center;margin-bottom:8px}
    .print-page{page-break-after:always;break-after:page}
    .print-table{width:100%;border-collapse:collapse;font-size:10.8px}
    .print-table th,.print-table td{border:1px solid #0f172a;padding:5px 6px;vertical-align:top}
    .print-table thead th{background:#f3f4f6}
    .tight th,.tight td{padding:4px 5px;font-size:10.2px}
    .avoid-break{page-break-inside:avoid;break-inside:avoid}
    .students-2col{columns:2;column-gap:12px}
    .students-2col ul{margin:0;padding-left:0;list-style:none}
    .students-2col li{break-inside:avoid;padding:2px 0;border-bottom:1px dotted #94a3b8}
    .att-table{width:100%;border-collapse:collapse;font-size:10px;margin-top:6px}
    .att-table th,.att-table td{border:1px solid #0f172a;padding:3px 4px;text-align:center}
    .att-table th:first-child,.att-table td:first-child{text-align:left}
  }
</style>
</head>
<body>
<div class="app">
  <div class="top no-print">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Fenomen Çocuk Kulübü</h1>
        <small>Grup dersleri planlama • Tablı</small>
      </div>
    </div>
    <div class="flex">
      <button class="btn ghost" id="btnSaveAll">Yerel Kaydet</button>
      <button class="btn ghost" id="btnLoadAll">Yerelden Yükle</button>
    </div>
  </div>

  <!-- ÜST SEKMELER -->
  <div class="tabs no-print" id="topTabs" role="tablist">
    <button class="tab" data-panel="step1" role="tab" aria-selected="true">1. Veri Kaynağı</button>
    <button class="tab" data-panel="step2" role="tab">2. Ders Programı</button>
    <button class="tab" data-panel="step3" role="tab">3. Müsaitlikler</button>
    <button class="tab" data-panel="step4" role="tab">4. Grup Talepleri</button>
    <button class="tab" data-panel="step5" role="tab">5. Atama Paneli</button>
    <button class="tab" data-panel="step6" role="tab">Yazdır</button>
  </div>

  <!-- STEP 1 -->
  <section class="content grid tabpanel" id="step1" role="tabpanel">
    <div class="section-title">
      <h2>1) Google Sheet Bağlantısı (YALNIZCA OKUMA)</h2>
      <div class="chips">
        <span class="pill">Ogretmenler: OGRETMEN_ADI, BRANS</span>
        <span class="pill">Ogrenciler: NO, ADSOYAD, SINIF, Grubu</span>
        <span class="pill">Branşlar: FEN BİLİMLERİ, MATEMATİK, TÜRKÇE, SOSYAL BİLGİLER, İNGİLİZCE, DİN KÜLTÜRÜ</span>
      </div>
    </div>
    <div class="row">
      <label class="wide">Spreadsheet ID
        <input class="wide" type="text" id="sheetId" value="1OeDI5rQvWXP6s5OhgRFrh1dThnBMmA9mrCjgYuk1Qtw" />
      </label>
      <button class="btn" id="btnFetch">Verileri Oku</button>
      <button class="btn ghost" id="btnClear">Temizle</button>
    </div>
    <div id="readStatus" class="notice">Durum: Hazır.</div>
    <div class="grid">
      <div class="card">
        <h3>Öğretmenler (filtreli)</h3>
        <table id="tblTeachers"><thead><tr><th>#</th><th>Öğretmen</th><th>Branş</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>Öğrenciler (Grubu dolu olanlar)</h3>
        <table id="tblStudents"><thead><tr><th>NO</th><th>Ad Soyad</th><th>Sınıf</th><th>Grup</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>Gruplar</h3>
        <div id="groupSummary" class="chips"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn sec right" id="goto2">Devam → Ders Programı</button>
    </div>
  </section>

  <!-- STEP 2 -->
  <section class="content grid tabpanel" id="step2" role="tabpanel" hidden>
    <div class="section-title">
      <h2>2) Ders Programı İskele</h2>
      <div class="chips"><span class="pill">JSON Kaydet/Yükle</span></div>
    </div>
    <div class="row">
      <label>Günler (virgül ayır)<br/>
        <input type="text" id="daysInput" value="Pazartesi,Salı,Çarşamba,Perşembe,Cuma" />
      </label>
      <label>Saat/Slot sayısı<br/>
        <input type="number" id="slotsInput" value="8" min="1" max="12" />
      </label>
      <label>Atama politikası<br/>
        <select id="assignPolicy" title="Program değişince atamaları nasıl ele alalım?">
          <option value="keep" selected>Koruyabildiğini koru (taşanları at)</option>
          <option value="reset">Tamamen sıfırla</option>
        </select>
      </label>
      <button class="btn" id="btnBuildGrid">Oluştur/Güncelle</button>
      <button class="btn ghost" id="btnProgExport">JSON Dışa Aktar</button>
      <input id="fileProgImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnProgImport">JSON İçeri Al</button>
    </div>

    <!-- Saat etiketleri düzenleyici -->
    <div id="slotLabelsWrap" class="card"></div>

    <div id="progGridWrap" class="card"></div>
    <div class="row">
      <button class="btn sec right" id="goto3">Devam → Müsaitlikler</button>
    </div>
  </section>

  <!-- STEP 3 -->
  <section class="content grid tabpanel" id="step3" role="tabpanel" hidden>
    <div class="section-title">
      <h2>3) Müsaitlikler</h2>
      <div class="legend">
        <span>● Öğretmen Müsaitliği (çift tık gün başlığı: günü kopyala)</span>
        <span>● Grup Müsaitliği (çift tık gün başlığı: günü kopyala)</span>
      </div>
    </div>

    <div class="tabs no-print" role="tablist" aria-label="Müsaitlik Sekmeleri">
      <button class="tab" id="tabTeach" role="tab" aria-selected="true">Öğretmen Müsaitlik</button>
      <button class="tab" id="tabGroup" role="tab" aria-selected="false">Grup Müsaitlik</button>
    </div>

    <div id="panelTeach" role="tabpanel">
      <div class="row no-print">
        <button class="btn ghost" id="btnAvailExport">JSON Dışa Aktar</button>
        <input id="fileAvailImport" type="file" accept="application/json" hidden />
        <button class="btn ghost" id="btnAvailImport">JSON İçeri Al</button>
        <button class="btn warn" id="btnAvailClear">Tüm Müsaitlikleri Temizle</button>
      </div>
      <div class="card">
        <h3>Öğretmen Müsaitlikleri</h3>
        <div id="teacherAvailWrap" class="avGrid"></div>
      </div>
    </div>

    <div id="panelGroup" role="tabpanel" hidden>
      <div class="row no-print">
        <button class="btn ghost" id="btnAvailExport2">JSON Dışa Aktar</button>
        <input id="fileAvailImport2" type="file" accept="application/json" hidden />
        <button class="btn ghost" id="btnAvailImport2">JSON İçeri Al</button>
      </div>
      <div class="card">
        <h3>Grup Müsaitlikleri</h3>
        <div id="groupAvailWrap" class="avGrid"></div>
      </div>
    </div>

    <div class="row">
      <button class="btn sec right" id="goto4">Devam → Grup Talepleri</button>
    </div>
  </section>

  <!-- STEP 4 -->
  <section class="content grid tabpanel" id="step4" role="tabpanel" hidden>
    <div class="section-title">
      <h2>4) Grupların Haftalık Ders Talepleri</h2>
      <div class="chips" id="branchChips"></div>
    </div>

    <div class="row">
      <label>Grup Seçin<br/>
        <select id="reqGroupSelect"></select>
      </label>
      <button class="btn ghost" id="btnReqExport">JSON Dışa Aktar</button>
      <input id="fileReqImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnReqImport">JSON İçeri Al</button>
      <button class="btn warn" id="btnReqClear">Tüm Talepleri Sıfırla</button>
    </div>

    <div id="reqWrap" class="grid"></div>

    <div class="row">
      <button class="btn sec right" id="goto5">Devam → Atama Paneli</button>
    </div>
  </section>

  <!-- STEP 5 -->
  <section class="content grid tabpanel" id="step5" role="tabpanel" hidden>
    <div class="section-title">
      <h2>5) Atama Paneli</h2>
      <div class="chips">
        <span class="pill">Aynı gruba ardışık aynı branş verilmez</span>
        <span class="pill">Branşa göre öğretmen yükü dengelenir</span>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnAutoAssign">Otomatik Atama</button>
      <button class="btn ghost" id="btnAssgnExport">JSON Dışa Aktar</button>
      <input id="fileAssgnImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnAssgnImport">JSON İçeri Al</button>
      <button class="btn warn" id="btnAssgnClear">Atamaları Temizle</button>
    </div>
    <div id="assignCards" class="cards"></div>

    <dialog id="dlgAssign">
      <header>Manuel Atama</header>
      <section>
        <div class="grid">
          <div class="inline-grid">
            <label>Grup<br/><input type="text" id="dlgGroup" readonly></label>
            <label>Gün / Saat<br/><input type="text" id="dlgWhen" readonly></label>
          </div>
          <div class="inline-grid">
            <label>Branş<br/><select id="dlgBranch"></select></label>
            <label>Öğretmen<br/><select id="dlgTeacher"></select></label>
          </div>
        </div>
      </section>
      <footer>
        <button class="btn ghost" id="dlgCancel">Vazgeç</button>
        <button class="btn" id="dlgOk">Kaydet</button>
      </footer>
    </dialog>

    <div class="row">
      <button class="btn sec right" id="goto6">Devam → Yazdır</button>
    </div>
  </section>

  <!-- STEP 6 -->
  <section class="content grid tabpanel" id="step6" role="tabpanel" hidden>
    <div class="section-title">
      <h2>Yazdır / Rapor</h2>
      <div class="chips no-print">
        <span class="pill">A4 çıktı, sayfa başı öğretmen/grup</span>
        <span class="pill">Sadece atama varsa</span>
      </div>
    </div>
    <div class="row no-print">
      <label>Görünüm<br/>
        <select id="printMode">
          <option value="group">Gruba göre</option>
          <option value="teacher">Öğretmene göre</option>
        </select>
      </label>
      <label>Filtre<br/>
        <select id="printFilter"></select>
      </label>
      <button class="btn" id="btnRenderPrint">Önizleme</button>
      <button class="btn sec" id="btnPrint" onclick="window.print()">Yazdır</button>
    </div>
    <div id="printPreview" class="grid printable"></div>
  </section>
</div>

<script>
/* ===== Global Durum ===== */
const ALLOWED_BRANCHES = [
  'FEN BİLİMLERİ','MATEMATİK','TÜRKÇE','SOSYAL BİLGİLER','İNGİLİZCE','DİN KÜLTÜRÜ'
];
const state = {
  teachers: [], students: [], groups: {}, branches: [],
  program: { days:["Pazartesi","Salı","Çarşamba","Perşembe","Cuma"], slots:8, slotLabels:[], cells:{} },
  availability: { teachers:{}, groups:{} },
  requests: {}, assignments: []
};

/* ===== Yardımcılar ===== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const toId = s => String(s).trim().toLowerCase().replace(/\s+/g,'-');
const keyDS = (d,s) => `${d}_${s}`;
const download = (name, obj) => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(obj, null, 2)],{type:'application/json'}));
  a.download = name; a.click();
};
const openFile = (inputEl, cb) => { inputEl.onchange = e=>{
  try{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => { try{ cb(JSON.parse(r.result)); }catch(err){ alert('Geçersiz JSON: '+err.message); } };
    r.readAsText(f); inputEl.value='';
  }catch(err){ alert('Dosya okunamadı: '+err.message); }
}; inputEl.click(); };
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

/* Grup sıralama:  G1-7A, G2-7A, G3-7A, ... G1-7B ... */
function parseGroupName(name){
  const s=String(name||'').trim().toUpperCase();
  // G<number>-<grade><section> -> G1-7A
  let m=s.match(/^G(\d+)-(\d+)\s*([A-ZÇĞİÖŞÜ])$/i);
  if(m) return {grp:+m[1], grade:+m[2], sec:m[3]};
  // Fallback: G<number>-<label>
  m=s.match(/^G(\d+)-(.+)$/i);
  if(m) return {grp:+m[1], grade:0, sec:m[2]};
  return null;
}
function groupComparator(a,b){
  const A=parseGroupName(a.name||a.id||a), B=parseGroupName(b.name||b.id||b);
  if(A && B){
    const keyA = String(A.grade).padStart(2,'0') + ' ' + String(A.sec);
    const keyB = String(B.grade).padStart(2,'0') + ' ' + String(B.sec);
    if(keyA!==keyB) return keyA.localeCompare(keyB,'tr');
    return (A.grp||0)-(B.grp||0);
  }
  return (a.name||a).localeCompare(b.name||b,'tr');
}

/* ===== Üst Sekmeler ===== */
function showTopTab(panelId){
  ['step1','step2','step3','step4','step5','step6'].forEach(id=>{
    const el = $('#'+id); if(!el) return;
    if(id===panelId) el.removeAttribute('hidden'); else el.setAttribute('hidden','');
  });
  $$('#topTabs .tab').forEach(tab=> tab.setAttribute('aria-selected', tab.dataset.panel===panelId ? 'true' : 'false'));

  if(panelId==='step2'){ buildProgramGrid(true); renderSlotLabels(); }
  if(panelId==='step3'){ reconcileAllToProgram(getAssignPolicy()); renderAvailGrids(); }
  if(panelId==='step4'){ refreshReqFilterOptions(); renderRequests(); }
  if(panelId==='step5'){ renderAssignCards(); }
  if(panelId==='step6'){ refreshPrintFilters(); renderPrintPreview(); }
}
function bindTopTabs(){ $$('#topTabs .tab').forEach(tab=> tab.addEventListener('click', ()=> showTopTab(tab.dataset.panel))); }

/* ===== 1) Veri Kaynağı ===== */
async function gvizFetch(sheetId, sheetName, selectRange){
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&headers=1${selectRange?`&range=${encodeURIComponent(selectRange)}`:''}`;
  const res = await fetch(url, {mode:'cors'}); const txt = await res.text();
  const json = JSON.parse(txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?$/)[1]);
  const cols = json.table.cols.map(c=>c.label);
  const rows = (json.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:'')); // why: boş hücreler için
  return {columns:cols, rows};
}
function renderTeachers(){
  const tb = $("#tblTeachers tbody"); tb.innerHTML='';
  state.teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${t.name}</td><td><span class="tag">${t.branch}</span></td>`;
    tb.appendChild(tr);
  });
}
function renderStudents(){
  const tb = $("#tblStudents tbody"); tb.innerHTML='';
  state.students.forEach(st=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="nowrap">${st.no}</td><td>${st.name}</td><td>${st.cls}</td><td><b>${st.group}</b></td>`;
    tb.appendChild(tr);
  });
}
function buildGroupsFromStudents(){
  state.groups = {};
  state.students.forEach(st=>{
    const gid = st.group;
    if(!state.groups[gid]) state.groups[gid] = { id:gid, name:gid, students:[] };
    state.groups[gid].students.push(st.no);
  });
}
function renderGroupSummary(){
  const wrap = $("#groupSummary"); wrap.innerHTML='';
  Object.values(state.groups).sort(groupComparator).forEach(g=>{
    const el = document.createElement('span'); el.className='pill';
    el.textContent = `${g.name} • ${g.students.length} öğrenci`;
    wrap.appendChild(el);
  });
}
async function fetchAll(){
  const sheetId = $("#sheetId").value.trim();
  $("#readStatus").textContent = "Okunuyor...";
  try{
    const t = await gvizFetch(sheetId, 'Ogretmenler');
    const cT = t.columns.map(s=>s.toUpperCase());
    const ixName = cT.indexOf('OGRETMEN_ADI');
    const ixBr   = cT.indexOf('BRANS');
    if(ixName<0 || ixBr<0) throw new Error("Ogretmenler sayfasında 'OGRETMEN_ADI' ve 'BRANS' yok.");
    state.teachers = t.rows.map(r=>{
      const name = (r[ixName]||'').toString().trim();
      const bRaw = (r[ixBr]||'').toString().trim().toUpperCase();
      return { id: toId(name||("T"+Math.random())), name, branch:bRaw };
    }).filter(x=>x.name && ALLOWED_BRANCHES.includes(x.branch));
    if(state.teachers.length===0) throw new Error("Filtre sonrası öğretmen bulunamadı.");

    const s = await gvizFetch(sheetId, 'Ogrenciler');
    const cS = s.columns.map(s=>s.toUpperCase());
    const ixNo = cS.indexOf('NO');
    const ixAd = cS.indexOf('ADSOYAD');
    const ixSn = cS.indexOf('SINIF');
    const ixGr = cS.indexOf('GRUBU');
    if(ixNo<0 || ixAd<0 || ixSn<0 || ixGr<0) throw new Error("Ogrenciler: NO/ADSOYAD/SINIF/Grubu eksik.");
    state.students = s.rows.map(r=>({
      no: r[ixNo], name: r[ixAd], cls: r[ixSn], group: (r[ixGr]||'').toString().trim()
    })).filter(x=>x.group);

    buildGroupsFromStudents();
    state.branches = Array.from(new Set(state.teachers.map(t=>t.branch))).sort((a,b)=>a.localeCompare(b));

    renderTeachers(); renderStudents(); renderGroupSummary();
    $("#readStatus").textContent = `Tamam: ${state.teachers.length} öğretmen, ${state.students.length} öğrenci, ${Object.keys(state.groups).length} grup.`;

    reconcileAllToProgram(getAssignPolicy());
  }catch(err){
    $("#readStatus").textContent = "Hata: " + err.message;
  }
}

/* ===== 2) Program ===== */
function getAssignPolicy(){ return $("#assignPolicy").value; }

function ensureSlotLabels(){ // why: yazdır ve müsaitlikte saatleri kullanmak
  const S = state.program.slots;
  if(!Array.isArray(state.program.slotLabels)) state.program.slotLabels = [];
  for(let i=0;i<S;i++) if(typeof state.program.slotLabels[i] !== 'string') state.program.slotLabels[i]='';
  if(state.program.slotLabels.length>S) state.program.slotLabels.length = S;
}
function renderSlotLabels(){
  ensureSlotLabels();
  const S = state.program.slots;
  const wrap = $("#slotLabelsWrap"); wrap.innerHTML='';
  const head = document.createElement('div'); head.className='kgrid'; head.style.setProperty('--cols', S); head.dataset.cols=S;
  head.appendChild(Object.assign(document.createElement('div'),{textContent:'Saat Etiketleri',style:'font-weight:800'}));
  for(let s=0;s<S;s++){
    const c=document.createElement('div'); c.className='kcell';
    const lab = state.program.slotLabels[s]||'';
    c.innerHTML = `<div class="mini">${s+1}. Ders</div><div>${lab||'—'}</div>`;
    c.title='Tıkla: saat gir (ör. 16:30-17:10). Alt+tık: bu etiketi boş slotlara kopyala.';
    c.addEventListener('click', (e)=>{
      const v = prompt(`${s+1}. ders için saat etiketi (ör. 16:30-17:10):`, state.program.slotLabels[s]||'');
      if(v!==null){ state.program.slotLabels[s]=v.trim(); renderSlotLabels(); }
    });
    c.addEventListener('auxclick', e=>{ e.preventDefault(); });
    c.addEventListener('mousedown', e=>{
      if(e.altKey){ // why: hızlı kopya
        const val = state.program.slotLabels[s]||'';
        for(let k=0;k<S;k++) if(!state.program.slotLabels[k]) state.program.slotLabels[k]=val;
        renderSlotLabels();
      }
    });
    head.appendChild(c);
  }
  wrap.appendChild(head);

  const tools=document.createElement('div'); tools.className='row';
  tools.innerHTML = `
    <div class="qty">
      <button class="xs" id="btnFillForward">Boşları soldan doldur</button>
    </div>
    <input id="bulkSlotLabels" class="wide" type="text" placeholder="Toplu yapıştır: 16:30-17:10; 17:20-18:00; ..." />
    <button class="btn ghost" id="btnApplyBulk">Uygula</button>
    <button class="btn ghost" id="btnClearLabels">Temizle</button>
  `;
  wrap.appendChild(tools);
  $("#btnFillForward").onclick = ()=>{
    for(let i=1;i<S;i++){ if(!state.program.slotLabels[i]) state.program.slotLabels[i]=state.program.slotLabels[i-1]||''; }
    renderSlotLabels();
  };
  $("#btnApplyBulk").onclick = ()=>{
    const txt = $("#bulkSlotLabels").value.trim();
    if(!txt) return;
    const parts = txt.split(';').map(x=>x.trim());
    for(let i=0;i<S;i++) state.program.slotLabels[i]=parts[i]||state.program.slotLabels[i]||'';
    renderSlotLabels();
  };
  $("#btnClearLabels").onclick = ()=>{ state.program.slotLabels = Array(S).fill(''); renderSlotLabels(); };
}

function buildProgramGrid(fromRestore=false){
  if(!fromRestore){
    state.program.days = $("#daysInput").value.split(',').map(s=>s.trim()).filter(Boolean);
    state.program.slots = clamp(parseInt($("#slotsInput").value||"8"), 1, 12);
  }
  ensureSlotLabels();
  const days = state.program.days, S = state.program.slots;
  const wrap = $("#progGridWrap"); wrap.innerHTML='';

  const head = document.createElement('div'); head.className='kgrid'; head.style.setProperty('--cols', S); head.dataset.cols=S;
  head.appendChild(Object.assign(document.createElement('div'),{textContent:'Gün / Saat',style:'font-weight:800'}));
  for(let s=0;s<S;s++){
    const label = state.program.slotLabels[s]||'';
    const hc = document.createElement('div'); hc.className='kcell busy';
    hc.innerHTML = `<div>${s+1}</div><div class="mini2">${label||''}</div>`;
    head.appendChild(hc);
  }
  wrap.appendChild(head);

  days.forEach((d,di)=>{
    const row = document.createElement('div');
    row.className = 'kgrid'; row.style.setProperty('--cols', S);
    const lbl = document.createElement('div'); lbl.textContent = d; lbl.style.fontWeight='800'; row.appendChild(lbl);
    for(let si=0; si<S; si++){
      const key = keyDS(di,si);
      const cell = document.createElement('div'); cell.className='kcell';
      cell.textContent = state.program.cells[key] || '';
      cell.title = "Not girmek için tıklayın (opsiyonel)";
      cell.onclick = ()=>{
        const val = prompt(`${d} - ${si+1}. saat için not:`, state.program.cells[key]||'');
        if(val!==null){ state.program.cells[key]=val.trim(); cell.textContent=state.program.cells[key]||''; }
      };
      row.appendChild(cell);
    }
    wrap.appendChild(row);
  });

  reconcileAllToProgram(getAssignPolicy());
}

/* Programla uyum */
function reconcileAllToProgram(policy='keep'){
  const D = state.program.days.length, S = state.program.slots;

  state.teachers.forEach(t=>{
    const cur = state.availability.teachers[t.id] || [];
    const next = Array.from({length:D},(_,d)=>Array.from({length:S},(_,s)=> (cur[d]?.[s] ?? true)));
    state.availability.teachers[t.id] = next;
  });
  Object.values(state.groups).forEach(g=>{
    const cur = state.availability.groups[g.id] || [];
    const next = Array.from({length:D},(_,d)=>Array.from({length:S},(_,s)=> (cur[d]?.[s] ?? true)));
    state.availability.groups[g.id] = next;
  });

  if(policy==='reset') state.assignments = [];
  else state.assignments = state.assignments.filter(a=> a.day<D && a.slot<S);
}

/* ===== 3) Müsaitlik ===== */
function slotHeadCells(container,S){
  for(let s=0;s<S;s++){
    const lab = state.program.slotLabels?.[s] || '';
    const hd = document.createElement('div'); hd.className='kcell busy';
    hd.innerHTML = `<div>${s+1}</div><div class="mini2">${lab}</div>`;
    container.appendChild(hd);
  }
}
function renderAvailGrids(){
  const D=state.program.days.length, S=state.program.slots, days=state.program.days;

  const tWrap=$("#teacherAvailWrap"); tWrap.innerHTML='';
  if(state.teachers.length===0){
    tWrap.innerHTML = '<div class="muted">Öğretmen verisi yok. Lütfen "Verileri Oku" ile yükleyin.</div>';
  }else{
    state.teachers.forEach(t=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='flex';
      head.innerHTML = `<b>👤 ${t.name}</b><span class="tag">${t.branch}</span>`;
      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='Tümünü Uygun';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='Tümünü Değil';
      const b3=document.createElement('button'); b3.className='btn xs ghost'; b3.textContent='Tersine';
      b1.onclick=()=>{ bulkSet(state.availability.teachers[t.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.teachers[t.id], false); renderAvailGrids(); };
      b3.onclick=()=>{ bulkToggle(state.availability.teachers[t.id]); renderAvailGrids(); };
      right.append(b1,b2,b3); head.appendChild(right); card.appendChild(head);

      const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
      const headRow = document.createElement('div'); headRow.textContent='Gün / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
      slotHeadCells(grid,S);
      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d]; dayLbl.style.fontWeight='700';
        dayLbl.title='Çift tıkla: bu günü tüm günlere kopyala';
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" gününü kopyala?`)){ copyDayPattern(state.availability.teachers[t.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.teachers[t.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.textContent = val?'Uygun':'Değil';
          cell.onclick = ()=>{
            const cur = state.availability.teachers[t.id][d][s] = !state.availability.teachers[t.id][d][s];
            cell.className='kcell ' + (cur?'ok':'bad'); cell.textContent = cur ? 'Uygun' : 'Değil';
          };
          row.appendChild(cell);
        }
        grid.appendChild(row);
      }
      card.appendChild(grid); tWrap.appendChild(card);
    });
  }

  const gWrap=$("#groupAvailWrap"); gWrap.innerHTML='';
  const groups = Object.values(state.groups);
  if(groups.length===0){
    gWrap.innerHTML = '<div class="muted">Grup verisi yok. Öğrencilerden gruplar türetilir.</div>';
  }else{
    groups.sort(groupComparator).forEach(g=>{
      const card = document.createElement('div'); card.className='card';
      const head = document.createElement('div'); head.className='flex';
      head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} öğrenci</span>`;
      const right = document.createElement('div'); right.className='right flex';
      const b1=document.createElement('button'); b1.className='btn xs ghost'; b1.textContent='Tümünü Uygun';
      const b2=document.createElement('button'); b2.className='btn xs ghost'; b2.textContent='Tümünü Değil';
      const b3=document.createElement('button'); b3.className='btn xs ghost'; b3.textContent='Tersine';
      b1.onclick=()=>{ bulkSet(state.availability.groups[g.id], true); renderAvailGrids(); };
      b2.onclick=()=>{ bulkSet(state.availability.groups[g.id], false); renderAvailGrids(); };
      b3.onclick=()=>{ bulkToggle(state.availability.groups[g.id]); renderAvailGrids(); };
      right.append(b1,b2,b3); head.appendChild(right); card.appendChild(head);

      const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
      const headRow = document.createElement('div'); headRow.textContent='Gün / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
      slotHeadCells(grid,S);
      for(let d=0; d<D; d++){
        const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
        const dayLbl = document.createElement('div'); dayLbl.textContent=days[d]; dayLbl.style.fontWeight='700';
        dayLbl.title='Çift tıkla: bu günü tüm günlere kopyala';
        dayLbl.ondblclick=()=>{ if(confirm(`"${days[d]}" gününü kopyala?`)){ copyDayPattern(state.availability.groups[g.id], d); renderAvailGrids(); } };
        row.appendChild(dayLbl);
        for(let s=0;s<S;s++){
          const val = state.availability.groups[g.id][d][s];
          const cell = document.createElement('div'); cell.className='kcell ' + (val?'ok':'bad');
          cell.textContent = val?'Uygun':'Değil';
          cell.onclick = ()=>{
            const cur = state.availability.groups[g.id][d][s] = !state.availability.groups[g.id][d][s];
            cell.className='kcell ' + (cur?'ok':'bad'); cell.textContent = cur ? 'Uygun' : 'Değil';
          };
          row.appendChild(cell);
        }
        grid.appendChild(row);
      }
      card.appendChild(grid); gWrap.appendChild(card);
    });
  }
}
function bulkSet(matrix, val){ for(let d=0; d<matrix.length; d++) for(let s=0; s<matrix[d].length; s++) matrix[d][s]=val; }
function bulkToggle(matrix){ for(let d=0; d<matrix.length; d++) for(let s=0; s<matrix[d].length; s++) matrix[d][s]=!matrix[d][s]; }
function copyDayPattern(matrix, fromDay){ const row = matrix[fromDay].slice(); for(let d=0; d<matrix.length; d++){ matrix[d] = row.slice(); } }

/* ===== 4) Talepler ===== */
function ensureRequests(){
  Object.values(state.groups).forEach(g=>{
    state.requests[g.id] = state.requests[g.id] || {};
    state.branches.forEach(b=>{
      if(typeof state.requests[g.id][b] !== 'number') state.requests[g.id][b] = 0;
    });
  });
}
function refreshReqFilterOptions(){
  const sel = $("#reqGroupSelect"); sel.innerHTML='';
  const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='(Grup seçin)'; sel.appendChild(opt0);
  Object.values(state.groups).sort(groupComparator).forEach(g=>{
    const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; sel.appendChild(opt);
  });
}
function totalRequestForGroup(gid){ const req = state.requests[gid]||{}; return Object.values(req).reduce((a,b)=>a+(+b||0),0); }

function renderRequests(){
  ensureRequests();
  const bc = $("#branchChips"); bc.innerHTML='';
  state.branches.forEach(b=>{ const x=document.createElement('span'); x.className='pill'; x.textContent=b; bc.appendChild(x); });

  const selVal = $("#reqGroupSelect").value;
  const wrap = $("#reqWrap"); wrap.innerHTML='';

  if(!selVal){ wrap.innerHTML = '<div class="muted">Soldan bir grup seçin. Seçilen gruba ait talepleri düzenleyin.</div>'; return; }

  const g = state.groups[selVal]; if(!g){ wrap.innerHTML='<div class="muted">Seçilen grup bulunamadı.</div>'; return; }

  const card = document.createElement('div'); card.className='card';

  const total = totalRequestForGroup(g.id);
  const capacity = state.program.days.length * state.program.slots;
  const chip = document.createElement('span'); chip.className='pill' + (total>capacity?' bad':'');

  chip.textContent = `Toplam: ${total} • Kapasite: ${capacity}`;

  const head = document.createElement('div'); head.className='flex';
  head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} öğrenci</span>`;
  head.appendChild(chip);
  card.appendChild(head);

  const tbl = document.createElement('table'); tbl.style.borderSpacing='0 6px';
  tbl.innerHTML = `<thead><tr><th>Branş</th><th style="width:240px">Saat</th></tr></thead><tbody></tbody>`;
  state.branches.forEach(b=>{
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent=b; tr.appendChild(td1);
    const td2 = document.createElement('td');
    const box = document.createElement('div'); box.className='qty';
    const minus = document.createElement('button'); minus.textContent='–';
    const inp = document.createElement('input'); inp.type='number'; inp.min='0'; inp.value=state.requests[g.id][b]||0;
    const plus = document.createElement('button'); plus.textContent='+';
    minus.onclick=()=>{ inp.value=Math.max(0, (+inp.value||0)-1); inp.dispatchEvent(new Event('input')); };
    plus.onclick=()=>{ inp.value=(+inp.value||0)+1; inp.dispatchEvent(new Event('input')); };
    inp.oninput = (e)=>{ state.requests[g.id][b] = clamp(parseInt(e.target.value||"0"),0,999); const t=totalRequestForGroup(g.id); chip.className='pill'+(t>capacity?' bad':''); chip.textContent=`Toplam: ${t} • Kapasite: ${capacity}`; };
    box.append(minus, inp, plus); td2.appendChild(box); tr.appendChild(td2);
    tbl.querySelector('tbody').appendChild(tr);
  });
  card.appendChild(tbl);
  wrap.appendChild(card);
}
const exportReq = ()=>download('grup-talepleri.json', state.requests);
const importReq = obj=>{
  if(!obj || typeof obj!=='object') return alert('Geçersiz talepler JSON.');
  state.requests = obj;
  refreshReqFilterOptions();
  renderRequests();
};

/* ===== 5) Atama ===== */
function findTeacherOptions(branch){ return state.teachers.filter(t=>t.branch===branch); }
function isTeacherBusy(teacherId, day, slot){ return state.assignments.some(a=>a.teacherId===teacherId && a.day===day && a.slot===slot); }
function isGroupBusy(groupId, day, slot){ return state.assignments.some(a=>a.group===groupId && a.day===day && a.slot===slot); }
function prevGroupSubject(groupId, day, slot){
  if(slot>0){ const a = state.assignments.find(x=>x.group===groupId && x.day===day && x.slot===slot-1); return a ? a.branch : null; }
  if(day>0){ const a = state.assignments.find(x=>x.group===groupId && x.day===day-1 && x.slot===state.program.slots-1); return a ? a.branch : null; }
  return null;
}
function hasAssignmentsForGroup(gid){ return state.assignments.some(a=>a.group===gid); }
function renderAssignCards(){
  const wrap = $("#assignCards"); wrap.innerHTML='';
  const days = state.program.days, S=state.program.slots;

  const groups = Object.values(state.groups).slice()
    .sort((a,b)=> (hasAssignmentsForGroup(b.id)?1:0)-(hasAssignmentsForGroup(a.id)?1:0) || groupComparator(a,b));

  groups.forEach(g=>{
    const card = document.createElement('div'); card.className='card';
    const head = document.createElement('div'); head.className='flex';
    const count = state.assignments.filter(a=>a.group===g.id).length;
    head.innerHTML = `<b>${g.name}</b><span class="tag">${g.students.length} öğrenci</span><span class="pill">${count} atama</span>`;
    card.appendChild(head);

    const grid = document.createElement('div'); grid.className='kgrid'; grid.style.setProperty('--cols', S); grid.dataset.cols=S;
    const headRow = document.createElement('div'); headRow.textContent='Gün / Saat'; headRow.style.fontWeight='700'; grid.appendChild(headRow);
    slotHeadCells(grid,S);

    for(let d=0; d<days.length; d++){
      const row = document.createElement('div'); row.className='kgrid'; row.style.setProperty('--cols', S);
      row.appendChild(Object.assign(document.createElement('div'),{textContent:days[d],style:'font-weight:700'}));
      for(let s=0; s<S; s++){
        const cell = document.createElement('div'); cell.className='kcell'; cell.dataset.d=d; cell.dataset.s=s;
        const cur = state.assignments.find(a=>a.group===g.id && a.day===d && a.slot===s);
        if(cur){
          cell.classList.add('busy');
          cell.innerHTML = `<div style="text-align:center"><div><b>${cur.branch}</b></div><div class="mini2">👤 ${state.teachers.find(t=>t.id===cur.teacherId)?.name||''}</div></div>`;
        }
        cell.onclick = ()=>{ openAssignDialog(g.id, d, s); };
        row.appendChild(cell);
      }
      grid.appendChild(row);
    }

    card.appendChild(grid);
    wrap.appendChild(card);
  });
}
const dlg = $("#dlgAssign"); let dlgCtx=null;
function openAssignDialog(group, day, slot){
  dlgCtx = {group, day, slot};
  $("#dlgGroup").value = group;
  const time = state.program.slotLabels?.[slot] || `${slot+1}. saat`;
  $("#dlgWhen").value = `${state.program.days[day]} • ${time}`;
  const selB = $("#dlgBranch"); selB.innerHTML='';
  state.branches.forEach(b=>{ const opt=document.createElement('option'); opt.value=b; opt.textContent=b; selB.appendChild(opt); });
  selB.onchange = fillTeachersForBranch;
  fillTeachersForBranch(); dlg.showModal();
}
function fillTeachersForBranch(){
  const branch = $("#dlgBranch").value;
  const selT = $("#dlgTeacher"); selT.innerHTML='';
  findTeacherOptions(branch).forEach(t=>{
    const opt = document.createElement('option'); opt.value=t.id; opt.textContent=t.name; selT.appendChild(opt);
  });
}
$("#dlgCancel").onclick = ()=> dlg.close();
$("#dlgOk").onclick = ()=>{
  const {group, day, slot} = dlgCtx;
  const branch = $("#dlgBranch").value;
  const teacherId = $("#dlgTeacher").value;
  if(isTeacherBusy(teacherId, day, slot)) if(!confirm("Öğretmen bu saatte başka derste. Yine de ata?")) return;
  if(isGroupBusy(group, day, slot)) if(!confirm("Bu gruba bu saatte başka atama var. Üzerine yazılsın mı?")) return;
  state.assignments = state.assignments.filter(a=>!(a.group===group && a.day===day && a.slot===slot));
  state.assignments.push({group, day, slot, branch, teacherId});
  dlg.close(); renderAssignCards();
};
function autoAssign(){
  const D = state.program.days.length, S = state.program.slots;
  const load = {}; state.branches.forEach(b=>{ load[b]={}; findTeacherOptions(b).forEach(t=>load[b][t.id]=0); });
  state.assignments.forEach(a=>{ if(load[a.branch] && load[a.branch][a.teacherId]!=null) load[a.branch][a.teacherId]++; });
  const groups = Object.values(state.groups).map(g=>{
    const need=[]; const req=state.requests[g.id]||{};
    Object.entries(req).forEach(([b,c])=>{ for(let i=0;i<c;i++) need.push(b); });
    return {id:g.id, need};
  });

  for(let d=0; d<D; d++){
    for(let s=0; s<S; s++){
      for(const g of groups){
        if(g.need.length===0) continue;
        if(state.availability.groups[g.id]?.[d]?.[s]!==true) continue;
        if(isGroupBusy(g.id, d, s)) continue;
        const prev = prevGroupSubject(g.id, d, s);
        const uniq = Array.from(new Set(g.need));
        const tryBranches = [...uniq.filter(b=>b!==prev), ...uniq.filter(b=>b===prev)];
        for(const b of tryBranches){
          const teachers = findTeacherOptions(b).filter(t=>{
            return state.availability.teachers[t.id]?.[d]?.[s]===true && !isTeacherBusy(t.id, d, s);
          });
          if(teachers.length===0) continue;
          teachers.sort((a,b2)=>(load[b][a.id]??0)-(load[b][b2.id]??0));
          const tPick=teachers[0];
          state.assignments = state.assignments.filter(a=>!(a.group===g.id && a.day===d && a.slot===s));
          state.assignments.push({group:g.id, day:d, slot:s, branch:b, teacherId:tPick.id});
          load[b][tPick.id] = (load[b][tPick.id]||0)+1;
          const idx=g.need.indexOf(b); if(idx>-1) g.need.splice(idx,1);
          break;
        }
      }
    }
  }
  renderAssignCards();
}
const exportAssgn = ()=>download('atamalar.json', state.assignments);
const importAssgn = obj=>{
  if(!Array.isArray(obj)) return alert('Geçersiz atamalar JSON.');
  state.assignments = obj;
  reconcileAllToProgram(getAssignPolicy());
  renderAssignCards();
};

/* ===== 6) Yazdır ===== */
function hasAnyAssignments(){ return state.assignments && state.assignments.length>0; }
function refreshPrintFilters(){
  const mode = $("#printMode").value;
  const sel = $("#printFilter"); sel.innerHTML='';
  if(mode==='group'){
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='(Tüm Gruplar)'; sel.appendChild(opt0);
    Object.values(state.groups).sort(groupComparator).forEach(g=>{
      const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; sel.appendChild(opt);
    });
  }else{
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='(Tüm Öğretmenler)'; sel.appendChild(opt0);
    state.teachers.forEach(t=>{
      const opt=document.createElement('option'); opt.value=t.id; opt.textContent=`${t.name} — ${t.branch}`; sel.appendChild(opt);
    });
  }
}
function renderPrintPreview(){
  const div = $("#printPreview"); div.innerHTML='';
  const mode = $("#printMode").value;
  const filter = $("#printFilter").value;
  const S = state.program.slots, days = state.program.days, labels = state.program.slotLabels || [];

  if(!hasAnyAssignments()){
    div.innerHTML = '<div class="muted">Atama yok. Önce atama yapın.</div>';
    $("#btnPrint").disabled = true; return;
  }
  $("#btnPrint").disabled = false;

  const hdr = document.createElement('div'); hdr.className='print-header';
  hdr.innerHTML = `<h2>Fenomen Çocuk Kulübü — ${mode==='group'?'Grup':'Öğretmen'} Ders Planı</h2>`;
  div.appendChild(hdr);

  if(mode==='group'){
    const groups = (filter ? [state.groups[filter]] : Object.values(state.groups))
      .filter(Boolean)
      .filter(g=>state.assignments.some(a=>a.group===g.id))
      .sort(groupComparator);

    groups.forEach(g=>{
      const aForG = state.assignments.filter(a=>a.group===g.id);
      const daysWith = Array.from(new Set(aForG.map(a=>a.day))).sort((a,b)=>a-b);
      if(daysWith.length===0) return;

      const page=document.createElement('div'); page.className='print-page';
      const wr = document.createElement('div'); wr.className='print-wrapper avoid-break';

      // Öğrenciler – iki sütun 👤
      const students = state.students.filter(st=>st.group===g.id).map(s=>s.name);
      const title = document.createElement('div'); title.className='print-sub';
      title.innerHTML = `<b>${g.name}</b> • Öğrenciler:`;
      wr.appendChild(title);

      const stCol = document.createElement('div'); stCol.className='students-2col';
      const ul = document.createElement('ul');
      students.forEach(n=>{
        const li=document.createElement('li'); li.innerHTML=`👤 ${n}`; ul.appendChild(li);
      });
      stCol.appendChild(ul); wr.appendChild(stCol);

      // Tablo – ortalı öğretmen isimleri
      const t = document.createElement('table'); t.className='print-table tight';
      const thead = `<tr><th>Gün / Saat</th>${Array.from({length:S},(_,i)=>`<th>${labels[i]||''}</th>`).join('')}</tr>`;
      let body='';
      days.forEach((d,di)=>{
        let row=`<tr><td><b>${days[di]}</b></td>`;
        for(let s=0; s<S; s++){
          const a = aForG.find(x=>x.day===di && x.slot===s);
          const txt = a ? `<div style="text-align:center"><b>${a.branch}</b><br/>👤 ${state.teachers.find(t=>t.id===a.teacherId)?.name||''}</div>` : '';
          row += `<td>${txt}</td>`;
        }
        row+='</tr>'; body+=row;
      });
      t.innerHTML = `<thead>${thead}</thead><tbody>${body}</tbody>`; wr.appendChild(t);

      page.appendChild(wr); div.appendChild(page);
    });

  } else {
    const teachers = (filter ? [state.teachers.find(t=>t.id===filter)] : state.teachers)
      .filter(Boolean)
      .filter(t=>state.assignments.some(a=>a.teacherId===t.id));

    teachers.forEach(t=>{
      const aForT = state.assignments.filter(a=>a.teacherId===t.id);
      const daysWith = Array.from(new Set(aForT.map(a=>a.day))).sort((a,b)=>a-b);
      if(daysWith.length===0) return;

      const page=document.createElement('div'); page.className='print-page';
      const wr = document.createElement('div'); wr.className='print-wrapper avoid-break';

      // Üst tablo — öğretmene göre, ortalı
      const tTbl = document.createElement('table'); tTbl.className='print-table tight';
      const thead = `<tr><th colspan="${S+1}" style="text-align:center">${t.name} — ${t.branch}</th></tr>
                     <tr><th>Gün / Saat</th>${Array.from({length:S},(_,i)=>`<th>${labels[i]||''}</th>`).join('')}</tr>`;
      let body='';
      daysWith.forEach(d=>{
        let row=`<tr><td><b>${days[d]}</b></td>`;
        for(let s=0; s<S; s++){
          const a = aForT.find(x=>x.day===d && x.slot===s);
          row += a ? `<td style="text-align:center"><b>${a.branch}</b><br/>Grup: ${state.groups[a.group]?.name||''}</td>` : `<td></td>`;
        }
        row+='</tr>'; body+=row;
      });
      tTbl.innerHTML = `<thead>${thead}</thead><tbody>${body}</tbody>`; wr.appendChild(tTbl);

      // Yoklama blokları — her grup için küçük tablo
      const groupsForT = Array.from(new Set(aForT.map(a=>a.group))).map(gid=>state.groups[gid]).filter(Boolean).sort(groupComparator);
      groupsForT.forEach(g=>{
        const blockTitle = document.createElement('div'); blockTitle.className='print-sub';
        blockTitle.innerHTML = `<b>${g.name}</b> • Öğrenci Yoklama`;
        wr.appendChild(blockTitle);

        const att = document.createElement('table'); att.className='att-table';
        att.innerHTML = `<thead>
            <tr><th>👤 Öğrenci</th><th>Geldi</th><th>Gelmedi</th><th>Geç Geldi</th><th>İzinli</th></tr>
          </thead><tbody></tbody>`;
        const tbody = att.querySelector('tbody');
        state.students.filter(s=>s.group===g.id).forEach(st=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${st.name}</td><td>□</td><td>□</td><td>□</td><td>□</td>`;
          tbody.appendChild(tr);
        });
        wr.appendChild(att);
      });

      page.appendChild(wr); div.appendChild(page);
    });
  }
}

/* ===== Olaylar ===== */
$("#btnFetch").onclick = fetchAll;
$("#btnClear").onclick = ()=>{
  state.teachers=[]; state.students=[]; state.groups={}; state.branches=[];
  renderTeachers(); renderStudents(); renderGroupSummary();
  $("#readStatus").textContent='Temizlendi.';
  reconcileAllToProgram(getAssignPolicy());
};

$("#btnBuildGrid").onclick = ()=>{ buildProgramGrid(false); renderSlotLabels(); };
$("#btnProgExport").onclick = ()=>download('ders-programi.json', state.program);
$("#btnProgImport").onclick = ()=>openFile($("#fileProgImport"), obj=>{
  if(!obj || !Array.isArray(obj.days) || typeof obj.slots!=='number') return alert('Geçersiz program JSON.');
  state.program = obj; if(!Array.isArray(state.program.slotLabels)) state.program.slotLabels=[];
  $("#daysInput").value = obj.days.join(','); $("#slotsInput").value = obj.slots;
  buildProgramGrid(true); renderSlotLabels();
  reconcileAllToProgram(getAssignPolicy());
  renderAvailGrids(); renderAssignCards(); refreshPrintFilters();
});

$("#btnAvailExport").onclick = ()=>download('musaitlikler.json', state.availability);
$("#btnAvailImport").onclick = ()=>openFile($("#fileAvailImport"), obj=>{
  if(!obj || !obj.teachers || !obj.groups) return alert('Geçersiz müsaitlik JSON.');
  state.availability = obj; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids();
});
$("#btnAvailClear").onclick = ()=>{ state.availability={teachers:{},groups:{}}; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids(); };
$("#btnAvailExport2").onclick = ()=>download('musaitlikler.json', state.availability);
$("#btnAvailImport2").onclick = ()=>openFile($("#fileAvailImport2"), obj=>{
  if(!obj || !obj.teachers || !obj.groups) return alert('Geçersiz müsaitlik JSON.');
  state.availability = obj; reconcileAllToProgram(getAssignPolicy()); renderAvailGrids();
});

$("#goto2").onclick = ()=> showTopTab('step2');
$("#goto3").onclick = ()=> showTopTab('step3');
$("#goto4").onclick = ()=> showTopTab('step4');
$("#goto5").onclick = ()=> showTopTab('step5');
$("#goto6").onclick = ()=> showTopTab('step6');

$("#btnReqExport").onclick = exportReq;
$("#btnReqImport").onclick = ()=>openFile($("#fileReqImport"), importReq);
$("#btnReqClear").onclick = ()=>{ state.requests={}; renderRequests(); };
$("#reqGroupSelect").onchange = renderRequests;

$("#btnAutoAssign").onclick = autoAssign;
$("#btnAssgnExport").onclick = exportAssgn;
$("#btnAssgnImport").onclick = ()=>openFile($("#fileAssgnImport"), importAssgn);
$("#btnAssgnClear").onclick = ()=>{ state.assignments=[]; renderAssignCards(); };

$("#printMode").onchange = ()=> { refreshPrintFilters(); renderPrintPreview(); };
$("#btnRenderPrint").onclick = renderPrintPreview;

$("#btnSaveAll").onclick = ()=>{
  try{
    localStorage.setItem('fenomen_tabs_plus2', JSON.stringify(state));
    alert('Yerel olarak kaydedildi.');
  }catch(err){ alert('Kaydetme hatası: '+err.message); }
};
$("#btnLoadAll").onclick = ()=>{
  try{
    const raw = localStorage.getItem('fenomen_tabs_plus2')
             || localStorage.getItem('fenomen_tabs_plus')
             || localStorage.getItem('fenomen_tabs_fix')
             || localStorage.getItem('fenomen_v2_tabs')
             || localStorage.getItem('fenomen_v2')
             || localStorage.getItem('fenomen_v1');
    if(!raw) return alert('Kayıt bulunamadı.');
    Object.assign(state, JSON.parse(raw));
    renderTeachers(); renderStudents();
    buildGroupsFromStudents(); renderGroupSummary();
    $("#daysInput").value = state.program.days.join(','); $("#slotsInput").value = state.program.slots;
    buildProgramGrid(true); renderSlotLabels();
    reconcileAllToProgram(getAssignPolicy());
    refreshReqFilterOptions(); renderRequests();
    renderAssignCards(); refreshPrintFilters(); renderPrintPreview();
    showTopTab('step1');
    alert('Yüklendi.');
  }catch(err){ alert('Yükleme hatası: '+err.message); }
};

/* Alt sekmeler (Müsaitlik) */
function showAvailTab(which){
  const teachActive = which==='teach';
  $("#panelTeach").toggleAttribute('hidden', !teachActive);
  $("#panelGroup").toggleAttribute('hidden', teachActive);
  $("#tabTeach").setAttribute('aria-selected', String(teachActive));
  $("#tabGroup").setAttribute('aria-selected', String(!teachActive));
}
$("#tabTeach").addEventListener('click', ()=>showAvailTab('teach'));
$("#tabGroup").addEventListener('click', ()=>showAvailTab('group'));

/* Başlangıç */
bindTopTabs();
buildProgramGrid(true);
renderSlotLabels();
showTopTab('step1');
</script>
</body>
</html>
