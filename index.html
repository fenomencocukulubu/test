function fillTeachersForBranch(){
  const branch = $("#dlgBranch").value;
  const {day, slot} = dlgCtx || {};
  const selT = $("#dlgTeacher"); selT.innerHTML='';

  const afterAnyAssign = hasAnyAssignments();               // WHY: “auto/any assign yapıldı mı?” koşulu
  const asgMap = afterAnyAssign ? getTeacherAssignmentsMap() : new Map();

  findTeacherOptions(branch).forEach(t=>{
    const availOk   = state.availability.teachers[t.id]?.[day]?.[slot] === true;
    const hasAnyAsg = afterAnyAssign && (asgMap.get(t.id)?.length > 0);

    // Otomatik atama yoksa: sadece uygunluk.
    // Otomatik atama varsa: uygunluk + öğretmenin hiç ataması olmama şartı.
    const ok = availOk && (!afterAnyAssign || !hasAnyAsg);

    const opt = document.createElement('option');
    opt.value = t.id;

    if (ok) {
      opt.textContent = t.name;
    } else {
      const reason = hasAnyAsg ? 'uygun değil • atanmış' : 'uygun değil';
      opt.textContent = `${t.name} (${reason})`;
      opt.disabled = true;
    }
    selT.appendChild(opt);
  });

  // Varsayılan olarak ilk uygun öğretmeni seç
  const firstEnabled = Array.from(selT.options).find(o=>!o.disabled);
  if(firstEnabled) selT.value = firstEnabled.value;
}
