<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fenomen Çocuk Kulübü • Grup Ders Planlama (tablı)</title>
  <style>
  :root{
    --bg:#f6f9fb; --panel:#ffffff; --ink:#0f172a; --muted:#64748b;
    --pri:#14b8a6; --pri-ink:#083c3a; --acc:#6366f1; --warn:#f59e0b; --danger:#ef4444;
    --chip:#e2f5f2; --grid:#e5e7eb; --radius:16px;
  }
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  h1,h2,h3{margin:0 0 .4rem}
  h1{font-size:clamp(20px,3vw,28px);font-weight:800}
  h2{font-size:clamp(18px,2.4vw,22px);font-weight:700}
  h3{font-size:clamp(16px,2vw,18px);font-weight:700}

  .app{max-width:1680px;margin:auto;padding:18px}
  .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--pri),#8b5cf6)}
  .brand .title small{color:var(--muted)}
  .content{background:var(--panel);border-radius:var(--radius);box-shadow:0 10px 25px rgba(15,23,42,.06);padding:16px}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  .btn{
    appearance:none;border:0;border-radius:12px;padding:10px 14px;
    background:var(--pri);color:#fff;font-weight:700;cursor:pointer
  }
  .btn.sm{padding:7px 10px;font-size:13px}
  .btn.xs{padding:6px 8px;font-size:12px;border-radius:10px}
  .btn.sec{background:var(--acc)}
  .btn.ghost{background:#e2e8f0;color:#0f172a}
  .btn.warn{background:var(--warn);color:#111827}
  .btn.danger{background:var(--danger)}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  input[type=text], input[type=number], select, textarea{
    padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;min-width:220px
  }
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:10px 12px;background:#fff;border-top:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb}
  th{position:sticky;top:0;background:#f8fafc;z-index:1}
  tr{border-radius:10px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);font-weight:600;color:var(--pri-ink)}
  .pill.bad{background:#fee2e2;color:#991b1b}
  .card{background:#fff;border-radius:16px;padding:14px;box-shadow:0 8px 20px rgba(15,23,42,.06);border:1px solid #e5e7eb;overflow:hidden}
  .kgrid{display:grid;gap:6px}
  .kgrid[data-cols]{grid-template-columns:140px repeat(var(--cols), minmax(72px,1fr));}
  .kcell{
    border:1px dashed var(--grid);
    min-height:60px;
    padding:6px;
    border-radius:10px;
    background:#fafafa;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    cursor:pointer;
    white-space:pre-line;
  }
  .kcell.busy{background:#eef2ff;border-color:#c7d2fe;cursor:default}
  .kcell.bad{background:#fee2e2;border-color:#fecaca}
  .kcell.ok{background:#dcfce7;border-color:#bbf7d0}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .legend span{padding:6px 10px;border-radius:20px;background:#f1f5f9}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .wide{width:100%}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(560px,1fr));gap:14px}
  .flex{display:flex;gap:10px;align-items:center}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .mini{font-size:12px}
  .mini2{font-size:11px;color:#475569}
  .tag{display:inline-block;background:#f1f5f9;padding:2px 8px;border-radius:999px;margin-left:6px;color:#334155}
  .nowrap{white-space:nowrap}
  .notice{font-size:13px;color:#475569}

  /* Müsaitlikler – Step3 özel tasarım (daha önceki hali korunarak) */
  #step3 {
    --avail-bg: #ffffff;
    --avail-ink: #0f172a;
    --avail-muted: #64748b;
    --avail-panel: #ffffff;
    --avail-border: #e5e7eb;
    --avail-grid-gap: 8px;

    --day-col-w: 160px;
    --slot-min-w: 88px;
    --cell-min-h: 58px;
    --cell-radius: 12px;

    --head-bg: #f8fafc;
    --head-ink: #0f172a;
    --head-border: #e2e8f0;

    --ok-bg: #dcfce7;
    --ok-ink: #065f46;
    --ok-bd: #bbf7d0;

    --bad-bg: #fee2e2;
    --bad-ink: #991b1b;
    --bad-bd: #fecaca;

    --neutral-bg: #f8fafc;
    --neutral-ink: #334155;
    --neutral-bd: #e2e8f0;

    --ring: #94a3b8;
    --ring-strong: #6366f1;

    color: var(--avail-ink);
  }
  #step3 .avGrid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(560px, 1fr));
    gap: 16px;
    align-items: stretch;
  }
  #step3 .avGrid .card {
    display: flex;
    flex-direction: column;
    background: var(--avail-panel);
    border: 1px solid var(--avail-border);
    border-radius: 16px;
    box-shadow: 0 10px 24px rgba(2, 8, 23, 0.06);
    overflow: clip;
    min-width: 0;
  }
  #step3 .avGrid .card .flex {
    padding: 12px 14px;
    gap: 10px;
    border-bottom: 1px solid var(--avail-border);
    background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
  }
  #step3 .avGrid .card .flex b { font-weight: 800; }
  #step3 .avGrid .card .tag {
    background: #eef2ff;
    color: #1f2937;
    border-radius: 999px;
    padding: 2px 10px;
    font-size: 12px;
  }
  #step3 .kgrid {
    display: grid;
    gap: var(--avail-grid-gap);
    padding: 12px;
    background: var(--avail-bg);
  }
  #step3 .kgrid[data-cols] {
    grid-template-columns: var(--day-col-w) repeat(var(--cols), minmax(var(--slot-min-w), 1fr));
  }
  #step3 .kgrid > :first-child {
    background: var(--head-bg);
    color: var(--head-ink);
    border: 1px solid var(--head-border);
    border-radius: var(--cell-radius);
    font-weight: 800;
    display: grid;
    place-items: center;
    min-height: var(--cell-min-h);
    text-align: center;
    padding: 6px 8px;
  }
  #step3 .kcell.busy {
    background: var(--head-bg);
    color: var(--avail-muted);
    border: 1px solid var(--head-border);
    cursor: default;
  }
  #step3 .kcell {
    border: 1px solid var(--neutral-bd);
    background: #ffffff;
    color: var(--neutral-ink);
    min-height: var(--cell-min-h);
    border-radius: var(--cell-radius);
    display: grid;
    place-items: center;
    text-align: center;
    padding: 6px;
    user-select: none;
    transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease, border-color .12s ease, color .12s ease;
    outline: none;
    position: relative;
  }
  #step3 .kcell.ok {
    background: var(--ok-bg);
    color: var(--ok-ink);
    border-color: var(--ok-bd);
    font-weight: 700;
  }
  #step3 .kcell.bad {
    background: var(--bad-bg);
    color: var(--bad-ink);
    border-color: var(--bad-bd);
    font-weight: 700;
  }
  #step3 .kgrid .kgrid .kcell:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 14px rgba(2, 8, 23, 0.06);
  }
  #step3 .kgrid .kgrid .kcell:active {
    transform: translateY(0);
    box-shadow: 0 1px 4px rgba(2, 8, 23, 0.08) inset;
  }
  #step3 .kgrid .kgrid .kcell:focus-visible {
    box-shadow: 0 0 0 3px var(--ring);
  }
  #step3 .mini2 { color: var(--avail-muted); font-size: 11px; }
  #step3 .avGrid .card .btn.xs.ghost {
    background: #f1f5f9;
    color: #111827;
    border-radius: 10px;
    padding: 6px 10px;
    border: 1px solid var(--avail-border);
  }
  #step3 .avGrid .card .btn.xs.ghost:hover {
    background: #e2e8f0;
  }
  #step3 .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 6px 0 12px;
  }
  #step3 .legend span {
    background: #f1f5f9;
    color: #334155;
    border-radius: 999px;
    padding: 6px 12px;
    font-weight: 600;
    border: 1px solid var(--avail-border);
  }
  #step3 .tabs {
    gap: 8px;
    border: 0;
    margin-bottom: 12px;
    position: relative;
  }
  #step3 .tabs::after {
    content: "";
    position: absolute; inset-inline: 0; bottom: -1px; height: 1px; background: var(--avail-border);
  }
  #step3 .tab {
    padding: 10px 14px;
    border-radius: 12px 12px 0 0;
    background: #f1f5f9;
    color: #0f172a;
    font-weight: 800;
    box-shadow: 0 1px 0 var(--avail-border) inset;
    border: 1px solid transparent;
  }
  #step3 .tab[aria-selected="true"] {
    background: #fff;
    border-color: var(--avail-border);
    border-bottom-color: #fff;
    box-shadow: 0 6px 18px rgba(2, 8, 23, .06);
  }
  @media (max-width: 920px) {
    #step3 { --day-col-w: 132px; --slot-min-w: 72px; }
    #step3 .avGrid { grid-template-columns: 1fr; }
    #step3 .kgrid { padding: 10px; }
    #step3 .kgrid > :first-child { padding: 6px; }
    #step3 .kcell { min-height: 52px; }
  }
  @media (min-width: 1600px) {
    #step3 { --slot-min-w: 100px; --cell-min-h: 64px; }
  }
  @media (prefers-reduced-motion: reduce) {
    #step3 .kcell { transition: none; }
  }
  @media (prefers-color-scheme: dark) {
    #step3 {
      --avail-bg: #0b1220;
      --avail-ink: #e5e7eb;
      --avail-muted: #94a3b8;
      --avail-panel: #0f172a;
      --avail-border: #1f2a44;

      --head-bg: #0d1a2d;
      --head-ink: #e5e7eb;
      --head-border: #1f2a44;

      --neutral-bg: #0f172a;
      --neutral-ink: #cbd5e1;
      --neutral-bd: #1f2a44;

      --ok-bg: #073a28;
      --ok-ink: #a7f3d0;
      --ok-bd: #115e43;

      --bad-bg: #3a0c0c;
      --bad-ink: #fecaca;
      --bad-bd: #7f1d1d;

      --ring: #334155;
      --ring-strong: #818cf8;
    }
    #step3 .avGrid .card {
      box-shadow: 0 12px 28px rgba(0,0,0,.36);
    }
    #step3 .avGrid .card .btn.xs.ghost {
      background: #0d1a2d; color: #e2e8f0; border-color: #1f2a44;
    }
    #step3 .avGrid .card .btn.xs.ghost:hover {
      background: #12233c;
    }
  }
  #step3 .kgrid .kgrid .kcell { cursor: pointer; }
  #step3 .kcell.busy { cursor: default; }

  /* Üst sekmeler */
  .tabs{display:flex;gap:6px;border-bottom:1px solid #e5e7eb;margin-bottom:8px}
  .tab{padding:10px 14px;border-radius:10px 10px 0 0;background:#eef2ff;color:#1f2937;cursor:pointer;font-weight:700;user-select:none}
  .tab[aria-selected="true"]{background:#fff;border:1px solid #e5e7eb;border-bottom-color:#fff}
  .tabpanel[hidden]{display:none !important}

  /* Talep sayacı kutucukları */
  .qty{display:inline-flex;align-items:center;border:1px solid #cbd5e1;border-radius:12px;overflow:hidden}
  .qty input{border:0;min-width:56px;text-align:center;padding:8px 10px}
  .qty button{border:0;background:#eef2ff;padding:8px 10px;cursor:pointer}

  /* Atama paneli – ders/slot renkleri */
  .kcell.assigned{
    background:#ffffff;
    border-style:solid;
    border-width:2px;
  }
  .kcell.assigned .sub-label{
    font-weight:700;
    font-size:11px;
    margin-bottom:2px;
  }
  .branch-fen{ border-color:#22c55e; }
  .branch-fen .sub-label{ color:#16a34a; }

  .branch-mat{ border-color:#0ea5e9; }
  .branch-mat .sub-label{ color:#0284c7; }

  .branch-tur{ border-color:#f97316; }
  .branch-tur .sub-label{ color:#ea580c; }

  .branch-sos{ border-color:#a855f7; }
  .branch-sos .sub-label{ color:#7e22ce; }

  .branch-ing{ border-color:#6366f1; }
  .branch-ing .sub-label{ color:#4f46e5; }

  .branch-dk{ border-color:#facc15; }
  .branch-dk .sub-label{ color:#ca8a04; }

  /* Yazdırma */
  @media print{
    @page{size:A4;margin:12mm}
    body{background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact}
    .no-print{display:none !important}
    .printable{display:block}
    .print-header{font-weight:900;text-align:center;margin-bottom:6px}
    .print-sub{color:#475569;text-align:center;margin-bottom:8px}
    .print-page{page-break-after:always;break-after:page}
    .print-table{width:100%;border-collapse:collapse;font-size:10.8px}
    .print-table th,.print-table td{border:1px solid #0f172a;padding:5px 6px;vertical-align:top}
    .print-table thead th{background:#f3f4f6}
    .tight th,.tight td{padding:4px 5px;font-size:10.2px}
    .avoid-break{page-break-inside:avoid;break-inside:avoid}
    .students-2col{columns:2;column-gap:12px}
    .students-2col ul{margin:0;padding-left:0;list-style:none}
    .students-2col li{break-inside:avoid;padding:2px 0;border-bottom:1px dotted #94a3b8}
  }
  </style>
</head>
<body>
<div class="app">
  <div class="top no-print">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Fenomen Çocuk Kulübü</h1>
        <small>Grup dersleri planlama • Tablı</small>
      </div>
    </div>
    <div class="flex">
      <button class="btn ghost" id="btnSaveAll">Yerel Kaydet</button>
      <button class="btn ghost" id="btnLoadAll">Yerelden Yükle</button>
    </div>
  </div>

  <!-- ÜST SEKMELER -->
  <div class="tabs no-print" id="topTabs" role="tablist">
    <button class="tab" data-panel="step1" role="tab" aria-selected="true">1. Veri Kaynağı</button>
    <button class="tab" data-panel="step2" role="tab">2. Ders Programı</button>
    <button class="tab" data-panel="step3" role="tab">3. Müsaitlikler</button>
    <button class="tab" data-panel="step4" role="tab">4. Grup Talepleri</button>
    <button class="tab" data-panel="step5" role="tab">5. Atama Paneli</button>
    <button class="tab" data-panel="step6" role="tab">Yazdır</button>
  </div>

  <!-- STEP 1 -->
  <section class="content grid tabpanel" id="step1" role="tabpanel">
    <div class="section-title">
      <h2>1) Google Sheet Bağlantısı (YALNIZCA OKUMA)</h2>
      <div class="chips">
        <span class="pill">Ogretmenler: OGRETMEN_ADI, BRANS</span>
        <span class="pill">Ogrenciler: NO, ADSOYAD, SINIF, Grubu</span>
        <span class="pill">Branşlar: FEN BİLİMLERİ, MATEMATİK, TÜRKÇE, SOSYAL BİLGİLER, İNGİLİZCE, DİN KÜLTÜRÜ</span>
      </div>
    </div>
    <div class="row">
      <label class="wide">Spreadsheet ID
        <input class="wide" type="text" id="sheetId" value="1oJGMO7FOPV4U86peeA63lmMk-wVCKsfWuyw2yefMweg" />
      </label>
      <button class="btn" id="btnFetch">Verileri Oku</button>
      <button class="btn ghost" id="btnClear">Temizle</button>
    </div>
    <div id="readStatus" class="notice">Durum: Hazır.</div>
    <div class="grid">
      <div class="card">
        <h3>Öğretmenler (filtreli)</h3>
        <table id="tblTeachers">
          <thead><tr><th>#</th><th>Öğretmen</th><th>Branş</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h3>Öğrenciler (Grubu dolu olanlar)</h3>
        <table id="tblStudents">
          <thead><tr><th>NO</th><th>Ad Soyad</th><th>Sınıf</th><th>Grup</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h3>Gruplar</h3>
        <div id="groupSummary" class="chips"></div>
      </div>
    </div>
    <div class="row">
      <button class="btn sec right" id="goto2">Devam → Ders Programı</button>
    </div>
  </section>

  <!-- STEP 2 -->
  <section class="content grid tabpanel" id="step2" role="tabpanel" hidden>
    <div class="section-title">
      <h2>2) Ders Programı İskele</h2>
      <div class="chips"><span class="pill">JSON Kaydet/Yükle</span></div>
    </div>
    <div class="row">
      <label>Günler (virgül ayır)<br/>
        <input type="text" id="daysInput" value="Pazartesi,Salı,Çarşamba,Perşembe,Cuma" />
      </label>
      <label>Saat/Slot sayısı<br/>
        <input type="number" id="slotsInput" value="8" min="1" max="12" />
      </label>
      <label>Atama politikası<br/>
        <select id="assignPolicy" title="Program değişince atamaları nasıl ele alalım?">
          <option value="keep" selected>Koruyabildiğini koru (taşanları at)</option>
          <option value="reset">Tamamen sıfırla</option>
        </select>
      </label>
      <button class="btn" id="btnBuildGrid">Oluştur/Güncelle</button>
      <button class="btn ghost" id="btnProgExport">JSON Dışa Aktar</button>
      <input id="fileProgImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnProgImport">JSON İçeri Al</button>
    </div>

    <div id="slotLabelsWrap" class="card"></div>
    <div id="progGridWrap" class="card"></div>

    <div class="row">
      <button class="btn sec right" id="goto3">Devam → Müsaitlikler</button>
    </div>
  </section>

  <!-- STEP 3 -->
  <section class="content grid tabpanel" id="step3" role="tabpanel" hidden>
    <div class="section-title">
      <h2>3) Müsaitlikler</h2>
      <div class="legend">
        <span>● Öğretmen Müsaitliği (çift tık gün başlığı: günü kopyala)</span>
        <span>● Grup Müsaitliği (çift tık gün başlığı: günü kopyala)</span>
      </div>
    </div>

    <div class="tabs no-print" role="tablist" aria-label="Müsaitlik Sekmeleri">
      <button class="tab" id="tabTeach" role="tab" aria-selected="true">Öğretmen Müsaitlik</button>
      <button class="tab" id="tabGroup" role="tab" aria-selected="false">Grup Müsaitlik</button>
    </div>

    <div id="panelTeach" role="tabpanel">
      <div class="row no-print">
        <button class="btn ghost" id="btnAvailExport">JSON Dışa Aktar</button>
        <input id="fileAvailImport" type="file" accept="application/json" hidden />
        <button class="btn ghost" id="btnAvailImport">JSON İçeri Al</button>
        <button class="btn warn" id="btnAvailClear">Tüm Müsaitlikleri Temizle</button>
      </div>
      <div class="card">
        <h3>Öğretmen Müsaitlikleri</h3>
        <div id="teacherAvailWrap" class="avGrid"></div>
      </div>
    </div>

    <div id="panelGroup" role="tabpanel" hidden>
      <div class="row no-print">
        <button class="btn ghost" id="btnAvailExport2">JSON Dışa Aktar</button>
        <input id="fileAvailImport2" type="file" accept="application/json" hidden />
        <button class="btn ghost" id="btnAvailImport2">JSON İçeri Al</button>
      </div>
      <div class="card">
        <h3>Grup Müsaitlikleri</h3>
        <div id="groupAvailWrap" class="avGrid"></div>
      </div>
    </div>

    <div class="row">
      <button class="btn sec right" id="goto4">Devam → Grup Talepleri</button>
    </div>
  </section>

  <!-- STEP 4 -->
  <section class="content grid tabpanel" id="step4" role="tabpanel" hidden>
    <div class="section-title">
      <h2>4) Grupların Haftalık Ders Talepleri</h2>
      <div class="chips" id="branchChips"></div>
    </div>

    <div class="row">
      <label>Grup Seçin<br/>
        <select id="reqGroupSelect"></select>
      </label>
      <button class="btn ghost" id="btnReqExport">JSON Dışa Aktar</button>
      <input id="fileReqImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnReqImport">JSON İçeri Al</button>
      <button class="btn warn" id="btnReqClear">Tüm Talepleri Sıfırla</button>
    </div>

    <div id="reqWrap" class="grid"></div>

    <div class="row">
      <button class="btn sec right" id="goto5">Devam → Atama Paneli</button>
    </div>
  </section>

  <!-- STEP 5 -->
  <section class="content grid tabpanel" id="step5" role="tabpanel" hidden>
    <div class="section-title">
      <h2>5) Atama Paneli</h2>
      <div class="chips">
        <span class="pill">Aynı gruba ardışık aynı branş verilmez (mümkün olduğunca)</span>
        <span class="pill">Branşa göre öğretmen yükü dengelenir</span>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnAutoAssign">Otomatik Atama</button>
      <button class="btn ghost" id="btnAssgnExport">JSON Dışa Aktar</button>
      <input id="fileAssgnImport" type="file" accept="application/json" hidden />
      <button class="btn ghost" id="btnAssgnImport">JSON İçeri Al</button>
      <button class="btn warn" id="btnAssgnClear">Atamaları Temizle</button>
    </div>
    <div id="assignCards" class="cards"></div>

    <dialog id="dlgAssign">
      <header>Manuel Atama</header>
      <section>
        <div class="grid">
          <div class="inline-grid">
            <label>Grup<br/><input type="text" id="dlgGroup" readonly></label>
            <label>Gün / Saat<br/><input type="text" id="dlgWhen" readonly></label>
          </div>
          <div class="inline-grid">
            <label>Branş<br/><select id="dlgBranch"></select></label>
            <label>Öğretmen<br/><select id="dlgTeacher"></select></label>
          </div>
        </div>
      </section>
      <footer>
        <button class="btn ghost" id="dlgCancel">Vazgeç</button>
        <button class="btn danger" id="dlgDelete" hidden>Atamayı Sil</button>
        <button class="btn" id="dlgOk">Kaydet</button>
      </footer>
    </dialog>

    <div class="row">
      <button class="btn sec right" id="goto6">Devam → Yazdır</button>
    </div>
  </section>

  <!-- STEP 6 -->
  <section class="content grid tabpanel" id="step6" role="tabpanel" hidden>
    <div class="section-title">
      <h2>Yazdır / Rapor</h2>
      <div class="chips no-print">
        <span class="pill">A4 çıktı, sayfa başı öğretmen/grup</span>
        <span class="pill">Sadece atama varsa</span>
      </div>
    </div>
    <div class="row no-print">
      <label>Görünüm<br/>
        <select id="printMode">
          <option value="group">Gruba göre</option>
          <option value="teacher">Öğretmene göre</option>
        </select>
      </label>
      <label>Filtre<br/>
        <select id="printFilter"></select>
      </label>
      <button class="btn" id="btnRenderPrint">Önizleme</button>
      <button class="btn sec" id="btnPrint" onclick="window.print()">Yazdır</button>
    </div>
    <div id="printPreview" class="grid printable"></div>
  </section>
</div>

<script>
/* ===== Global Durum ===== */
const ALLOWED_BRANCHES = [
  'FEN BİLİMLERİ','MATEMATİK','TÜRKÇE','SOSYAL BİLGİLER','İNGİLİZCE','DİN KÜLTÜRÜ'
];

const BRANCH_CLASS = {
  'FEN BİLİMLERİ':'branch-fen',
  'MATEMATİK':'branch-mat',
  'TÜRKÇE':'branch-tur',
  'SOSYAL BİLGİLER':'branch-sos',
  'İNGİLİZCE':'branch-ing',
  'DİN KÜLTÜRÜ':'branch-dk'
};

const state = {
  teachers: [],
  students: [],
  groups: {},
  branches: [],
  program: {
    days:["Pazartesi","Salı","Çarşamba","Perşembe","Cuma"],
    slots:8,
    slotLabels:[],
    cells:{}
  },
  availability: {
    teachers:{},
    groups:{}
  },
  requests: {},
  assignments: []
};

const LS_KEY = 'fenomen-grup-planlama-v1';
let autoFetchDone = false;

/* ===== Yardımcılar ===== */
const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const toId = s => String(s).trim().toLowerCase().replace(/\s+/g,'-');
const keyDS = (d,s) => `${d}_${s}`;
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

const download = (name, obj) => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(obj, null, 2)],{type:'application/json'}));
  a.download = name;
  a.click();
};

const openFile = (inputEl, cb) => {
  inputEl.onchange = e=>{
    try{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = () => {
        try{
          cb(JSON.parse(r.result));
        }catch(err){
          alert('Geçersiz JSON: '+err.message);
        }
      };
      r.readAsText(f);
      inputEl.value='';
    }catch(err){
      alert('Dosya okunamadı: '+err.message);
    }
  };
  inputEl.click();
};

function escapeHtml(str){
  return String(str ?? '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}
function escapeAttr(str){
  return escapeHtml(str);
}
function branchClass(branch){
  return BRANCH_CLASS[String(branch||'').toUpperCase()] || '';
}

/* Grup sıralama: G1-7A, G2-7A, ... */
function parseGroupName(name){
  const s = String(name||'').trim().toUpperCase();
  let m = s.match(/^G(\d+)-(\d+)\s*([A-ZÇĞİÖŞÜ])$/i);
  if(m) return {grp:+m[1], grade:+m[2], sec:m[3]};
  m = s.match(/^G(\d+)-(.+)$/i);
  if(m) return {grp:+m[1], grade:0, sec:m[2]};
  return null;
}
function groupComparator(a,b){
  const A=parseGroupName(a.name||a.id||a), B=parseGroupName(b.name||b.id||b);
  if(A && B){
    const keyA = String(A.grade).padStart(2,'0') + ' ' + String(A.sec);
    const keyB = String(B.grade).padStart(2,'0') + ' ' + String(B.sec);
    if(keyA!==keyB) return keyA.localeCompare(keyB,'tr');
    return (A.grp||0)-(B.grp||0);
  }
  return (a.name||a).localeCompare(b.name||b,'tr');
}
function getSortedGroups(){
  return Object.values(state.groups).sort(groupComparator);
}

/* ===== Üst Sekmeler ===== */
function showTopTab(panelId){
  ['step1','step2','step3','step4','step5','step6'].forEach(id=>{
    const el = $('#'+id);
    if(!el) return;
    if(id===panelId) el.removeAttribute('hidden');
    else el.setAttribute('hidden','');
  });
  $$('#topTabs .tab').forEach(tab=>{
    tab.setAttribute('aria-selected', tab.dataset.panel===panelId ? 'true' : 'false');
  });

  if(panelId==='step2'){
    buildProgramFromInputs();
    buildProgramGrid();
    renderSlotLabels();
  }
  if(panelId==='step3'){
    reconcileAllToProgram(getAssignPolicy());
    renderAvailGrids();
  }
  if(panelId==='step4'){
    ensureRequests();
    refreshReqFilterOptions();
    renderRequests();
    renderBranchChipsSummary();
  }
  if(panelId==='step5'){
    renderAssignCards();
  }
  if(panelId==='step6'){
    refreshPrintFilters();
    renderPrintPreview();
  }
}

function bindTopTabs(){
  $$('#topTabs .tab').forEach(tab=>{
    tab.addEventListener('click', ()=> showTopTab(tab.dataset.panel));
  });
}

/* ===== 1) Google Sheet ===== */
async function gvizFetch(sheetId, sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  const res = await fetch(url);
  const text = await res.text();
  const m = text.match(/google\.visualization\.Query\.setResponse\((.*)\);?/s);
  if(!m) throw new Error('Google Sheets cevabı çözümlenemedi.');
  const json = JSON.parse(m[1]);
  const table = json.table;
  const cols = (table.cols||[]).map(c=>String(c.label||'').trim());
  const rows = (table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:''));
  return {columns:cols, rows};
}

function renderTeachers(){
  const tbody = $('#tblTeachers tbody');
  tbody.innerHTML = '';
  state.teachers.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(t.name)}</td><td>${escapeHtml(t.branch)}</td>`;
    tbody.appendChild(tr);
  });
}

function renderStudents(){
  const tbody = $('#tblStudents tbody');
  tbody.innerHTML = '';
  state.students.forEach(st=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(st.no)}</td>
      <td>${escapeHtml(st.name)}</td>
      <td>${escapeHtml(st.cls||'')}</td>
      <td>${escapeHtml(st.group)}</td>`;
    tbody.appendChild(tr);
  });
}

function buildGroupsFromStudents(){
  const groups = {};
  state.students.forEach(st=>{
    const gName = String(st.group||'').trim();
    if(!gName) return;
    if(!groups[gName]) groups[gName] = {id:gName, name:gName, students:[]};
    groups[gName].students.push(st);
  });
  state.groups = groups;
}

function renderGroupSummary(){
  const wrap = $('#groupSummary');
  wrap.innerHTML = '';
  const groups = getSortedGroups();
  if(!groups.length){
    wrap.innerHTML = '<span class="muted">Henüz grup yok.</span>';
    return;
  }
  groups.forEach(g=>{
    const span = document.createElement('span');
    span.className='pill';
    span.textContent = `${g.name} • ${g.students.length} öğrenci`;
    wrap.appendChild(span);
  });
}

async function fetchAll(){
  const sheetId = $('#sheetId').value.trim();
  if(!sheetId){
    alert('Önce Spreadsheet ID girin.');
    return;
  }
  $('#readStatus').textContent = 'Durum: Google Sheet okunuyor...';
  try{
    // Öğretmenler
    const tData = await gvizFetch(sheetId,'Ogretmenler');
    const tc = tData.columns.map(c=>c.toUpperCase());
    const ixName = tc.indexOf('OGRETMEN_ADI');
    const ixBranch = tc.indexOf('BRANS');
    if(ixName<0 || ixBranch<0) throw new Error('Ogretmenler sayfasında OGRETMEN_ADI veya BRANS sütunu bulunamadı.');
    state.teachers = tData.rows
      .filter(r => String(r[ixName]||'').trim())
      .map((r,i)=>({
        id: 'T'+(i+1),
        name: String(r[ixName]).trim(),
        branch: String(r[ixBranch]||'').trim().toUpperCase()
      }))
      .filter(t => !ALLOWED_BRANCHES.length || ALLOWED_BRANCHES.includes(t.branch));

    // Öğrenciler
    const sData = await gvizFetch(sheetId,'Ogrenciler');
    const sc = sData.columns.map(c=>c.toUpperCase());
    const ixNo    = sc.indexOf('NO');
    const ixSName = sc.indexOf('ADSOYAD');
    const ixCls   = sc.indexOf('SINIF');
    const ixGroup = sc.indexOf('GRUBU');
    if(ixNo<0 || ixSName<0 || ixGroup<0) throw new Error('Ogrenciler sayfasında NO / ADSOYAD / Grubu sütunu eksik.');
    state.students = sData.rows
      .filter(r => String(r[ixGroup]||'').trim())
      .map(r=>({
        no: String(r[ixNo]).trim(),
        name: String(r[ixSName]).trim(),
        cls: String(r[ixCls]||'').trim(),
        group: String(r[ixGroup]).trim()
      }));

    // Branşlar - ayrı sayfa varsa
    let branches = [];
    try{
      const bData = await gvizFetch(sheetId,'Branslar');
      const bRows = bData.rows || [];
      branches = bRows
        .map(r => String((r[0] ?? '')).trim().toUpperCase())
        .filter(Boolean);
    }catch(e){
      // yoksa öğretmen branşlarından türet
      const set = new Set();
      state.teachers.forEach(t=>set.add(t.branch));
      branches = Array.from(set);
    }
    // ALLOWED filtre
    if(ALLOWED_BRANCHES.length){
      branches = branches.filter(b=>ALLOWED_BRANCHES.includes(b));
    }
    state.branches = Array.from(new Set(branches));

    buildGroupsFromStudents();
    renderTeachers();
    renderStudents();
    renderGroupSummary();

    // Program, müsaitlik, talepler ve atamalar reset
    state.requests = {};
    state.assignments = [];
    state.availability = {teachers:{},groups:{}};

    ensureSlotLabels();
    buildProgramFromInputs();
    buildProgramGrid();
    ensureAvailabilityStructures();
    ensureRequests();
    renderAvailGrids();
    refreshReqFilterOptions();
    renderRequests();
    renderBranchChipsSummary();
    renderAssignCards();
    refreshPrintFilters();
    renderPrintPreview();

    $('#readStatus').textContent = 'Durum: Tamamlandı.';
    showTopTab('step2');
  }catch(err){
    console.error(err);
    $('#readStatus').textContent = 'Durum: Hata - '+err.message;
    alert('Veriler okunamadı: '+err.message);
  }
}

function clearAll(){
  state.teachers = [];
  state.students = [];
  state.groups = {};
  state.branches = [];
  state.program = {
    days:["Pazartesi","Salı","Çarşamba","Perşembe","Cuma"],
    slots:8,
    slotLabels:[],
    cells:{}
  };
  state.availability = {teachers:{}, groups:{}};
  state.requests = {};
  state.assignments = [];

  renderTeachers();
  renderStudents();
  renderGroupSummary();
  $('#progGridWrap').innerHTML='';
  $('#slotLabelsWrap').innerHTML='';
  $('#teacherAvailWrap').innerHTML='';
  $('#groupAvailWrap').innerHTML='';
  $('#reqWrap').innerHTML='';
  $('#branchChips').innerHTML='';
  $('#assignCards').innerHTML='';
  $('#printPreview').innerHTML='';
  $('#readStatus').textContent = 'Durum: Temizlendi.';
}

/* ===== 2) Ders Programı ===== */
function getAssignPolicy(){
  return $('#assignPolicy').value || 'keep';
}
function ensureSlotLabels(){
  const S = state.program.slots;
  if(!Array.isArray(state.program.slotLabels)) state.program.slotLabels = [];
  const arr = state.program.slotLabels;
  for(let i=0;i<S;i++){
    if(!arr[i]) arr[i] = (i+1)+'. Saat';
  }
  state.program.slotLabels = arr.slice(0,S);
}
function buildProgramFromInputs(){
  const daysStr = $('#daysInput').value || '';
  const days = daysStr.split(',').map(s=>s.trim()).filter(Boolean);
  const slots = clamp(parseInt($('#slotsInput').value||'8',10)||8,1,12);
  state.program.days = days.length ? days : ["Pazartesi","Salı","Çarşamba","Perşembe","Cuma"];
  state.program.slots = slots;
  ensureSlotLabels();
}
function reconcileAllToProgram(policy){
  const D = state.program.days.length;
  const S = state.program.slots;
  ensureSlotLabels();

  if(policy === 'reset'){
    state.assignments = [];
    state.availability = {teachers:{}, groups:{}};
  }else{
    state.assignments = state.assignments.filter(a=>a.day < D && a.slot < S);
    // Müsaitlik matrislerini kırp
    ['teachers','groups'].forEach(kind=>{
      const map = state.availability[kind];
      Object.keys(map).forEach(id=>{
        const mat = map[id] || [];
        const newMat = Array.from({length:D},(_,d)=>{
          const row = mat[d] || [];
          return Array.from({length:S},(_,s)=> !!row[s]);
        });
        map[id] = newMat;
      });
    });
  }
}

function buildProgramGrid(){
  const wrap = $('#progGridWrap');
  wrap.innerHTML = '';
  const days = state.program.days;
  const S = state.program.slots;
  const labels = state.program.slotLabels;
  const grid = document.createElement('div');
  grid.className = 'kgrid';
  grid.style.setProperty('--cols', S);

  // Başlık satırı
  const head0 = document.createElement('div');
  head0.className = 'kcell busy';
  head0.textContent = 'Gün / Saat';
  grid.appendChild(head0);
  for(let s=0;s<S;s++){
    const c = document.createElement('div');
    c.className='kcell busy mini2';
    c.textContent = labels[s] || (s+1)+'. Saat';
    grid.appendChild(c);
  }

  // Gün satırları
  for(let d=0; d<days.length; d++){
    const dayCell = document.createElement('div');
    dayCell.className='kcell busy';
    dayCell.textContent = days[d];
    grid.appendChild(dayCell);

    for(let s=0;s<S;s++){
      const key = keyDS(d,s);
      const cell = document.createElement('div');
      cell.className='kcell';
      const val = state.program.cells[key] || '';
      cell.innerHTML = `<input type="text" data-d="${d}" data-s="${s}" value="${escapeAttr(val)}" />`;
      grid.appendChild(cell);
    }
  }

  wrap.appendChild(grid);

  // input event
  wrap.querySelectorAll('input[type="text"]').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const d = +e.target.dataset.d;
      const s = +e.target.dataset.s;
      const key = keyDS(d,s);
      state.program.cells[key] = e.target.value;
    });
  });
}

function renderSlotLabels(){
  const wrap = $('#slotLabelsWrap');
  wrap.innerHTML = '';
  const S = state.program.slots;
  ensureSlotLabels();
  const labels = state.program.slotLabels;

  const inner = document.createElement('div');
  inner.className='row';
  for(let i=0;i<S;i++){
    const lab = document.createElement('label');
    lab.innerHTML = `${i+1}. saat etiketi<br/>`;
    const inp = document.createElement('input');
    inp.type='text';
    inp.value = labels[i] || (i+1)+'. Saat';
    inp.dataset.ix = String(i);
    inp.addEventListener('input', e=>{
      const ix = +e.target.dataset.ix;
      state.program.slotLabels[ix] = e.target.value.trim() || (ix+1)+'. Saat';
      // başlıkları da güncelle
      buildProgramGrid();
    });
    lab.appendChild(inp);
    inner.appendChild(lab);
  }
  wrap.innerHTML = '<h3>Saat Etiketleri</h3>';
  wrap.appendChild(inner);
}

/* ===== 3) Müsaitlik ===== */
function ensureAvailabilityStructures(){
  const D = state.program.days.length;
  const S = state.program.slots;

  // Öğretmenler
  const tMap = state.availability.teachers;
  state.teachers.forEach(t=>{
    const id = t.id;
    const mat = tMap[id] || [];
    const newMat = Array.from({length:D},(_,d)=>{
      const row = mat[d] || [];
      return Array.from({length:S},(_,s)=> !!row[s]);
    });
    tMap[id] = newMat;
  });
  Object.keys(tMap).forEach(id=>{
    if(!state.teachers.find(t=>t.id===id)) delete tMap[id];
  });

  // Gruplar
  const gMap = state.availability.groups;
  getSortedGroups().forEach(g=>{
    const id = g.id;
    const mat = gMap[id] || [];
    const newMat = Array.from({length:D},(_,d)=>{
      const row = mat[d] || [];
      return Array.from({length:S},(_,s)=> !!row[s]);
    });
    gMap[id] = newMat;
  });
  Object.keys(gMap).forEach(id=>{
    if(!state.groups[id]) delete gMap[id];
  });
}

function renderAvailGrids(){
  const D = state.program.days.length;
  const S = state.program.slots;
  const days = state.program.days;
  ensureAvailabilityStructures();

  const slotLabels = state.program.slotLabels.length
    ? state.program.slotLabels
    : Array.from({length:S},(_,i)=>(i+1)+'. Saat');

  const tWrap = $('#teacherAvailWrap');
  const gWrap = $('#groupAvailWrap');
  tWrap.innerHTML = '';
  gWrap.innerHTML = '';

  // Öğretmen Müsaitlikleri
  if(!state.teachers.length){
    tWrap.innerHTML = '<p class="muted">Önce öğretmen listesini yükleyin.</p>';
  }else{
    state.teachers.forEach(t=>{
      const card = document.createElement('div');
      card.className='card';

      const header = document.createElement('div');
      header.className='flex';
      const b = document.createElement('b');
      b.textContent = t.name;
      const tag = document.createElement('span');
      tag.className='tag';
      tag.textContent = t.branch;
      const mini = document.createElement('span');
      mini.className='mini right';
      const mat = state.availability.teachers[t.id];
      const totalOk = mat.flat().filter(Boolean).length;
      mini.textContent = `Uygun slot: ${totalOk}`;
      header.appendChild(b);
      header.appendChild(tag);
      header.appendChild(mini);

      const grid = document.createElement('div');
      grid.className='kgrid';
      grid.style.setProperty('--cols',S);

      const head0 = document.createElement('div');
      head0.className='kcell busy';
      head0.textContent='Gün / Saat';
      grid.appendChild(head0);
      for(let s=0;s<S;s++){
        const c = document.createElement('div');
        c.className='kcell busy mini2';
        c.textContent = slotLabels[s];
        grid.appendChild(c);
      }

      for(let d=0; d<D; d++){
        const dayCell = document.createElement('div');
        dayCell.className='kcell busy';
        dayCell.textContent = days[d];
        dayCell.title = 'Çift tıkla: bu günü aşağıdaki diğer günlere kopyala';
        dayCell.addEventListener('dblclick', ()=>{
          const srcRow = state.availability.teachers[t.id][d];
          for(let d2=0; d2<D; d2++){
            if(d2===d) continue;
            state.availability.teachers[t.id][d2] = srcRow.slice();
          }
          renderAvailGrids();
        });
        grid.appendChild(dayCell);

        for(let s=0;s<S;s++){
          const cell = document.createElement('div');
          cell.className='kcell';
          cell.dataset.kind='teacher';
          cell.dataset.id=t.id;
          cell.dataset.d=String(d);
          cell.dataset.s=String(s);
          const ok = !!state.availability.teachers[t.id][d][s];
          if(ok) cell.classList.add('ok');
          else cell.classList.add('bad');
          cell.textContent = ok ? 'Uygun' : 'Değil';
          cell.addEventListener('click', ()=>{
            const cur = !!state.availability.teachers[t.id][d][s];
            state.availability.teachers[t.id][d][s] = !cur;
            cell.classList.toggle('ok', !cur);
            cell.classList.toggle('bad', cur);
            cell.textContent = !cur ? 'Uygun' : 'Değil';
          });
          grid.appendChild(cell);
        }
      }

      card.appendChild(header);
      card.appendChild(grid);
      tWrap.appendChild(card);
    });
  }

  // Grup Müsaitlikleri
  const groups = getSortedGroups();
  if(!groups.length){
    gWrap.innerHTML = '<p class="muted">Henüz grup yok.</p>';
  }else{
    groups.forEach(g=>{
      const card = document.createElement('div');
      card.className='card';
      const header = document.createElement('div');
      header.className='flex';
      const b = document.createElement('b');
      b.textContent = g.name;
      const tag = document.createElement('span');
      tag.className='tag';
      tag.textContent = `${g.students.length} öğrenci`;
      const mini = document.createElement('span');
      mini.className='mini right';
      const mat = state.availability.groups[g.id];
      const totalOk = mat.flat().filter(Boolean).length;
      mini.textContent = `Uygun slot: ${totalOk}`;
      header.appendChild(b);
      header.appendChild(tag);
      header.appendChild(mini);

      const grid = document.createElement('div');
      grid.className='kgrid';
      grid.style.setProperty('--cols',S);

      const head0 = document.createElement('div');
      head0.className='kcell busy';
      head0.textContent='Gün / Saat';
      grid.appendChild(head0);
      for(let s=0;s<S;s++){
        const c = document.createElement('div');
        c.className='kcell busy mini2';
        c.textContent = slotLabels[s];
        grid.appendChild(c);
      }

      for(let d=0; d<D; d++){
        const dayCell = document.createElement('div');
        dayCell.className='kcell busy';
        dayCell.textContent = days[d];
        dayCell.title = 'Çift tıkla: bu günü aşağıdaki diğer günlere kopyala';
        dayCell.addEventListener('dblclick', ()=>{
          const srcRow = state.availability.groups[g.id][d];
          for(let d2=0; d2<D; d2++){
            if(d2===d) continue;
            state.availability.groups[g.id][d2] = srcRow.slice();
          }
          renderAvailGrids();
        });
        grid.appendChild(dayCell);

        for(let s=0;s<S;s++){
          const cell = document.createElement('div');
          cell.className='kcell';
          const ok = !!state.availability.groups[g.id][d][s];
          if(ok) cell.classList.add('ok');
          else cell.classList.add('bad');
          cell.textContent = ok ? 'Uygun' : 'Değil';
          cell.addEventListener('click', ()=>{
            const cur = !!state.availability.groups[g.id][d][s];
            state.availability.groups[g.id][d][s] = !cur;
            cell.classList.toggle('ok', !cur);
            cell.classList.toggle('bad', cur);
            cell.textContent = !cur ? 'Uygun' : 'Değil';
          });
          grid.appendChild(cell);
        }
      }

      card.appendChild(header);
      card.appendChild(grid);
      gWrap.appendChild(card);
    });
  }
}

/* ===== 4) Talepler ===== */
function ensureRequests(){
  const groups = getSortedGroups();
  const branches = state.branches;
  const req = state.requests;

  // Silinen grupları temizle
  Object.keys(req).forEach(gid=>{
    if(!state.groups[gid]) delete req[gid];
  });

  groups.forEach(g=>{
    const cur = req[g.id] || {};
    branches.forEach(b=>{
      const key = String(b).toUpperCase();
      if(typeof cur[key] !== 'number') cur[key] = 0;
    });
    req[g.id] = cur;
  });
}

function totalRequestForGroup(gid){
  const r = state.requests[gid] || {};
  return Object.values(r).reduce((a,v)=>a+(v||0),0);
}

function refreshReqFilterOptions(){
  const sel = $('#reqGroupSelect');
  sel.innerHTML = '';
  const groups = getSortedGroups();
  if(!groups.length){
    sel.innerHTML = '<option value="">(Grup yok)</option>';
    return;
  }
  groups.forEach(g=>{
    const opt = new Option(g.name, g.id);
    sel.add(opt);
  });
  if(!sel.value && groups.length) sel.value = groups[0].id;
}

function renderRequests(){
  const wrap = $('#reqWrap');
  wrap.innerHTML = '';
  const gid = $('#reqGroupSelect').value;
  const groups = getSortedGroups();
  if(!gid || !groups.length){
    wrap.innerHTML = '<p class="muted">Önce grup seçin.</p>';
    return;
  }
  ensureRequests();
  const req = state.requests[gid] || {};
  const branches = state.branches.slice();

  const card = document.createElement('div');
  card.className='card';

  const title = document.createElement('h3');
  title.textContent = `Grup: ${gid}`;
  card.appendChild(title);

  branches.forEach(br=>{
    const key = String(br).toUpperCase();
    const row = document.createElement('div');
    row.className='row';
    const left = document.createElement('div');
    left.innerHTML = `<b>${escapeHtml(br)}</b>`;
    const qty = document.createElement('div');
    qty.className='qty';
    const btnMinus = document.createElement('button');
    btnMinus.type='button';
    btnMinus.textContent='-';
    const inp = document.createElement('input');
    inp.type='number';
    inp.min='0';
    inp.max=String(state.program.days.length*state.program.slots);
    inp.value = req[key] || 0;
    const btnPlus = document.createElement('button');
    btnPlus.type='button';
    btnPlus.textContent='+';

    btnMinus.addEventListener('click', ()=>{
      const v = clamp(parseInt(inp.value||'0',10)-1,0,999);
      inp.value = v;
      req[key] = v;
      renderBranchChipsSummary();
    });
    btnPlus.addEventListener('click', ()=>{
      const v = clamp(parseInt(inp.value||'0',10)+1,0,999);
      inp.value = v;
      req[key] = v;
      renderBranchChipsSummary();
    });
    inp.addEventListener('input', ()=>{
      const v = clamp(parseInt(inp.value||'0',10)||0,0,999);
      inp.value = v;
      req[key] = v;
      renderBranchChipsSummary();
    });

    qty.appendChild(btnMinus);
    qty.appendChild(inp);
    qty.appendChild(btnPlus);

    row.appendChild(left);
    row.appendChild(qty);
    card.appendChild(row);
  });

  state.requests[gid] = req;
  wrap.appendChild(card);
}

function renderBranchChipsSummary(){
  const wrap = $('#branchChips');
  wrap.innerHTML = '';
  if(!state.branches.length){
    wrap.innerHTML = '<span class="muted">Branş listesi boş.</span>';
    return;
  }
  ensureRequests();
  const chipData = state.branches.map(br=>{
    const key = String(br).toUpperCase();
    let total = 0;
    Object.keys(state.requests).forEach(gid=>{
      total += state.requests[gid][key] || 0;
    });
    const tCount = state.teachers.filter(t=>t.branch===key).length;
    return {branch:br,total, teachers:tCount};
  });

  chipData.forEach(c=>{
    const span = document.createElement('span');
    span.className='pill';
    span.textContent = `${c.branch}: ${c.total} ders, ${c.teachers} öğretmen`;
    wrap.appendChild(span);
  });
}

/* ===== 5) Atamalar ===== */
let dlgCtx = null;

function getTeacherById(id){
  return state.teachers.find(t=>t.id===id) || null;
}

function renderAssignCards(){
  const container = $('#assignCards');
  container.innerHTML = '';
  const groups = getSortedGroups();
  const D = state.program.days.length;
  const S = state.program.slots;
  if(!groups.length || !D || !S){
    container.innerHTML = '<p class="muted">Önce veri kaynaklarını ve ders programını hazırlayın.</p>';
    return;
  }
  const days = state.program.days;
  const labels = state.program.slotLabels.length ? state.program.slotLabels : Array.from({length:S},(_,i)=>(i+1)+'. Saat');
  const teacherMap = new Map(state.teachers.map(t=>[t.id,t]));

  groups.forEach(g=>{
    const card = document.createElement('div');
    card.className='card';

    const header = document.createElement('div');
    header.className='flex';
    const left = document.createElement('div');
    left.innerHTML = `<b>${escapeHtml(g.name)}</b><span class="tag">${g.students.length} öğrenci</span>`;
    const right = document.createElement('div');
    right.className='mini right';
    const totalReq = totalRequestForGroup(g.id);
    const totalAss = state.assignments.filter(a=>a.groupId===g.id).length;
    right.textContent = `${totalAss}/${totalReq} ders atanmış`;
    header.appendChild(left);
    header.appendChild(right);
    card.appendChild(header);

    const grid = document.createElement('div');
    grid.className='kgrid';
    grid.style.setProperty('--cols',S);

    const head0 = document.createElement('div');
    head0.className='kcell busy';
    head0.textContent='Gün / Saat';
    grid.appendChild(head0);
    for(let s=0;s<S;s++){
      const c = document.createElement('div');
      c.className='kcell busy mini2';
      c.textContent = labels[s];
      grid.appendChild(c);
    }

    for(let d=0; d<D; d++){
      const dayCell = document.createElement('div');
      dayCell.className='kcell busy';
      dayCell.textContent = days[d];
      grid.appendChild(dayCell);

      for(let s=0;s<S;s++){
        const cell = document.createElement('div');
        cell.className='kcell';
        cell.dataset.gid = g.id;
        cell.dataset.d = String(d);
        cell.dataset.s = String(s);

        const ass = state.assignments.find(a=>a.groupId===g.id && a.day===d && a.slot===s);
        if(ass){
          cell.classList.add('assigned');
          const cls = branchClass(ass.branch);
          if(cls) cell.classList.add(cls);
          const teacher = teacherMap.get(ass.teacherId);
          const tName = teacher ? teacher.name : '(Öğretmen yok)';
          cell.innerHTML = `<div class="mini2 sub-label">${escapeHtml(ass.branch)}</div>
                            <div>${escapeHtml(tName)}</div>`;
        }else{
          const avail = state.availability.groups[g.id]?.[d]?.[s];
          if(avail===true) cell.classList.add('ok');
          else cell.classList.add('bad');
        }

        cell.addEventListener('click', ()=>{
          openAssignDialog(g.id, d, s);
        });
        grid.appendChild(cell);
      }
    }

    card.appendChild(grid);
    container.appendChild(card);
  });
}

function computeTeacherStats(){
  const D = state.program.days.length;
  const S = state.program.slots;
  const stats = {};
  state.teachers.forEach(t=>{
    const id = t.id;
    const mat = state.availability.teachers[id] || [];
    let totalAvail = 0;
    let assigned = 0;
    for(let d=0; d<D; d++){
      for(let s=0; s<S; s++){
        const avail = !!(mat[d]?.[s]);
        const hasAss = state.assignments.some(a=>a.teacherId===id && a.day===d && a.slot===s);
        if(avail && !hasAss) totalAvail++;
        if(hasAss) assigned++;
      }
    }
    stats[id] = {totalAvail, assigned};
  });
  return stats;
}

function fillBranchOptionsForDialog(groupId){
  const sel = $('#dlgBranch');
  sel.innerHTML = '';
  const branches = state.branches.slice();
  const req = state.requests[groupId] || {};
  branches.forEach(br=>{
    const key = String(br).toUpperCase();
    const requested = req[key] || 0;
    const assigned = state.assignments.filter(a=>a.groupId===groupId && a.branch===key).length;
    const opt = new Option(`${br} (T:${requested} / A:${assigned})`, key);
    sel.add(opt);
  });
  if(!sel.value && branches.length) sel.value = String(branches[0]).toUpperCase();
}

function fillTeacherOptionsForDialog(branchKey, day, slot, groupId){
  const sel = $('#dlgTeacher');
  sel.innerHTML = '';
  const branchUpper = String(branchKey||'').toUpperCase();
  const teachers = state.teachers.filter(t=>t.branch===branchUpper);
  const stats = computeTeacherStats();

  if(!teachers.length){
    const opt = new Option('Bu branş için öğretmen yok','');
    opt.disabled = true;
    sel.add(opt);
    return;
  }

  teachers.forEach(t=>{
    const id = t.id;
    const mat = state.availability.teachers[id] || [];
    const avail = !!(mat[day]?.[slot]);
    const hasAss = state.assignments.some(a=>a.teacherId===id && a.day===day && a.slot===slot);
    const st = stats[id] || {totalAvail:0, assigned:0};
    let label = `${t.name} — T.A:${st.totalAvail} / A.A.D:${st.assigned}`;
    const opt = new Option(label, id);
    if(!avail || hasAss){
      opt.disabled = true;
      if(!avail) label += ' (bu saatte uygun değil)';
    }
    opt.textContent = label;
    sel.add(opt);
  });

  // Önce mevcut atanmış öğretmeni seç
  if(dlgCtx && dlgCtx.index>=0){
    const a = state.assignments[dlgCtx.index];
    sel.value = a.teacherId;
  }else{
    const firstEnabled = Array.from(sel.options).find(o=>!o.disabled);
    if(firstEnabled) sel.value = firstEnabled.value;
  }
}

function openAssignDialog(groupId, day, slot){
  dlgCtx = {groupId, day, slot, index:-1};
  const g = state.groups[groupId];
  $('#dlgGroup').value = g ? g.name : groupId;
  const dayName = state.program.days[day] || '';
  const slotLabel = (state.program.slotLabels[slot] || ((slot+1)+'. Saat'));
  $('#dlgWhen').value = `${dayName} / ${slotLabel}`;

  fillBranchOptionsForDialog(groupId);

  // Mevcut atama var mı?
  const idx = state.assignments.findIndex(a=>a.groupId===groupId && a.day===day && a.slot===slot);
  dlgCtx.index = idx;
  if(idx>=0){
    const a = state.assignments[idx];
    $('#dlgBranch').value = String(a.branch).toUpperCase();
    $('#dlgDelete').hidden = false;
  }else{
    $('#dlgDelete').hidden = true;
  }

  fillTeacherOptionsForDialog($('#dlgBranch').value, day, slot, groupId);

  $('#dlgBranch').onchange = ()=>{
    fillTeacherOptionsForDialog($('#dlgBranch').value, day, slot, groupId);
  };

  $('#dlgAssign').showModal();
}

function closeAssignDialog(){
  $('#dlgAssign').close();
  dlgCtx = null;
}

function deleteAssignmentFromDialog(){
  if(!dlgCtx) return;
  const {groupId, day, slot} = dlgCtx;
  state.assignments = state.assignments.filter(a=>!(a.groupId===groupId && a.day===day && a.slot===slot));
  closeAssignDialog();
  renderAssignCards();
  refreshPrintFilters();
}

function saveAssignmentFromDialog(){
  if(!dlgCtx) return;
  const {groupId, day, slot} = dlgCtx;
  const branchKey = $('#dlgBranch').value;
  const teacherId = $('#dlgTeacher').value;
  if(!branchKey){
    alert('Branş seçin.');
    return;
  }
  if(!teacherId){
    alert('Öğretmen seçin.');
    return;
  }

  const conflict = state.assignments.find(a=>
    a.day===day && a.slot===slot &&
    (a.teacherId===teacherId || a.groupId===groupId)
  );
  if(conflict && !(conflict.groupId===groupId && conflict.teacherId===teacherId)){
    alert('Bu saat için öğretmen veya grup başka derse atanmış. Önce o atamayı silin.');
    return;
  }

  // Aynı grup-saate ait eski kaydı sil
  state.assignments = state.assignments.filter(a=>!(a.groupId===groupId && a.day===day && a.slot===slot));
  state.assignments.push({
    groupId,
    day,
    slot,
    branch: branchKey,
    teacherId
  });

  closeAssignDialog();
  renderAssignCards();
  refreshPrintFilters();
}

/* ===== Otomatik Atama (grup talepleri + farklı öğretmen) ===== */
function autoAssign(){
  const D = state.program.days.length;
  const S = state.program.slots;
  const groups = getSortedGroups();
  if(!groups.length){
    alert('Önce grupları oluşturun.');
    return;
  }
  if(!state.teachers.length){
    alert('Önce öğretmenleri yükleyin.');
    return;
  }
  if(!D || !S){
    alert('Önce ders programını oluşturun.');
    return;
  }

  ensureAvailabilityStructures();
  ensureRequests();

  const branches = state.branches.map(b=>String(b).toUpperCase());
  const days = state.program.days;

  // Gridler
  const gGrid = new Map(); // groupId -> [D][S]
  const tGrid = new Map(); // teacherId -> [D][S]

  function ensureGroupGrid(gid){
    if(!gGrid.has(gid)){
      const mat = Array.from({length:D},()=>Array(S).fill(null));
      gGrid.set(gid, mat);
    }
    return gGrid.get(gid);
  }
  function ensureTeacherGrid(tid){
    if(!tGrid.has(tid)){
      const mat = Array.from({length:D},()=>Array(S).fill(null));
      tGrid.set(tid, mat);
    }
    return tGrid.get(tid);
  }

  // Mevcut atamaları yansıt
  state.assignments = state.assignments.filter(a=>a.day<D && a.slot<S);
  state.assignments.forEach(a=>{
    const gMat = ensureGroupGrid(a.groupId);
    const tMat = ensureTeacherGrid(a.teacherId);
    gMat[a.day][a.slot] = a;
    tMat[a.day][a.slot] = a;
  });

  // Öğretmen yükleri
  const teacherLoad = {};
  state.assignments.forEach(a=>{
    teacherLoad[a.teacherId] = (teacherLoad[a.teacherId]||0)+1;
  });

  // Grup-branch ihtiyaçları ve kullanılan öğretmen setleri
  const needs = {}; // gid -> {branch:kalan}
  const usedTB = {}; // gid -> {branch:Set(teacherId)}
  groups.forEach(g=>{
    const gid = g.id;
    needs[gid] = {};
    usedTB[gid] = {};
    const req = state.requests[gid] || {};
    branches.forEach(br=>{
      const requested = req[br] || 0;
      const already = state.assignments.filter(a=>a.groupId===gid && a.branch===br).length;
      needs[gid][br] = Math.max(0, requested - already);
      usedTB[gid][br] = new Set(
        state.assignments
          .filter(a=>a.groupId===gid && a.branch===br)
          .map(a=>a.teacherId)
      );
    });
  });

  function prevBranchForGroup(gid, day, slot){
    const mat = gGrid.get(gid);
    if(!mat) return null;
    if(slot>0){
      const prev = mat[day][slot-1];
      return prev ? prev.branch : null;
    }
    return null;
  }

  function pickTeacherForSlot(branch, gid, day, slot){
    const branchUpper = String(branch).toUpperCase();
    const candidates = state.teachers.filter(t=>t.branch===branchUpper);
    if(!candidates.length) return null;

    const arr = candidates.filter(t=>{
      const mat = ensureTeacherGrid(t.id);
      const avail = !!(state.availability.teachers[t.id]?.[day]?.[slot]);
      if(!avail) return false;
      if(mat[day][slot]) return false; // aynı anda iki ders olamaz
      return true;
    });
    if(!arr.length) return null;

    arr.sort((a,b)=>{
      const usedA = usedTB[gid][branchUpper].has(a.id) ? 1 : 0;
      const usedB = usedTB[gid][branchUpper].has(b.id) ? 1 : 0;
      if(usedA!==usedB) return usedA-usedB; // 0 (kullanılmamış) önce gelir
      const loadA = teacherLoad[a.id] || 0;
      const loadB = teacherLoad[b.id] || 0;
      if(loadA!==loadB) return loadA-loadB;
      return a.name.localeCompare(b.name,'tr');
    });
    return arr[0].id;
  }

  let newCount = 0;

  function tryFill(pass){
    // pass 1: aynı branş arka arkaya olmasın
    // pass 2: gerekirse izin ver
    for(const g of groups){
      const gid = g.id;
      for(const br of branches){
        let remain = needs[gid][br] || 0;
        if(remain<=0) continue;
        for(let d=0; d<D && remain>0; d++){
          const gAvailRow = state.availability.groups[gid]?.[d] || [];
          for(let s=0; s<S && remain>0; s++){
            if(gAvailRow[s] !== true) continue;
            const gMat = ensureGroupGrid(gid);
            if(gMat[d][s]) continue; // zaten dolu
            if(pass===1){
              const prev = prevBranchForGroup(gid,d,s);
              if(prev && String(prev).toUpperCase() === String(br).toUpperCase()) continue;
            }
            const tid = pickTeacherForSlot(br,gid,d,s);
            if(!tid) continue;

            const ass = {groupId:gid, day:d, slot:s, branch:br, teacherId:tid};
            state.assignments.push(ass);
            ensureGroupGrid(gid)[d][s] = ass;
            ensureTeacherGrid(tid)[d][s] = ass;
            teacherLoad[tid] = (teacherLoad[tid]||0)+1;
            usedTB[gid][br].add(tid);
            needs[gid][br]--;
            remain--;
            newCount++;
          }
        }
      }
    }
  }

  tryFill(1);
  tryFill(2);

  renderAssignCards();
  refreshPrintFilters();

  alert(`Otomatik atama tamamlandı.\nYeni atanan ders sayısı: ${newCount}`);
}

/* ===== 6) Yazdırma ===== */
function hasAnyAssignments(){
  return state.assignments && state.assignments.length>0;
}

function refreshPrintFilters(){
  const sel = $('#printFilter');
  sel.innerHTML = '';
  if(!hasAnyAssignments()){
    sel.add(new Option('(Atama yok)',''));
    return;
  }
  const mode = $('#printMode').value;
  if(mode==='group'){
    const groups = getSortedGroups().filter(g=>state.assignments.some(a=>a.groupId===g.id));
    sel.add(new Option('Tüm gruplar','all'));
    groups.forEach(g=> sel.add(new Option(g.name,g.id)));
  }else{
    const teachers = state.teachers.filter(t=>state.assignments.some(a=>a.teacherId===t.id));
    sel.add(new Option('Tüm öğretmenler','all'));
    teachers.forEach(t=> sel.add(new Option(t.name,t.id)));
  }
}

function renderPrintPreview(){
  const container = $('#printPreview');
  container.innerHTML = '';
  if(!hasAnyAssignments()){
    container.innerHTML = '<p class="muted">Henüz atama yok.</p>';
    return;
  }
  const mode = $('#printMode').value;
  const filter = $('#printFilter').value || 'all';
  if(mode==='group'){
    renderPrintByGroup(container, filter);
  }else{
    renderPrintByTeacher(container, filter);
  }
}

function renderPrintByGroup(container, filter){
  const D = state.program.days.length;
  const S = state.program.slots;
  const days = state.program.days;
  const labels = state.program.slotLabels.length ? state.program.slotLabels : Array.from({length:S},(_,i)=>(i+1)+'. Saat');
  const teacherMap = new Map(state.teachers.map(t=>[t.id,t]));

  const groups = getSortedGroups().filter(g=>{
    const has = state.assignments.some(a=>a.groupId===g.id);
    if(!has) return false;
    if(filter!=='all' && filter!==g.id) return false;
    return true;
  });
  if(!groups.length){
    container.innerHTML = '<p class="muted">Seçilen filtreye göre atama yok.</p>';
    return;
  }

  groups.forEach(g=>{
    const page = document.createElement('section');
    page.className='print-page avoid-break';

    const h = document.createElement('div');
    h.className='print-header';
    h.textContent = `Grup: ${g.name}`;
    const sub = document.createElement('div');
    sub.className='print-sub';
    sub.textContent = `${D} gün x ${S} slot`;
    page.appendChild(h);
    page.appendChild(sub);

    const table = document.createElement('table');
    table.className='print-table tight';
    const thead = document.createElement('thead');
    let tr = document.createElement('tr');
    tr.innerHTML = '<th>Gün / Saat</th>' + labels.map(l=>`<th>${escapeHtml(l)}</th>`).join('');
    thead.appendChild(tr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    for(let d=0; d<D; d++){
      tr = document.createElement('tr');
      const th = document.createElement('th');
      th.textContent = days[d];
      tr.appendChild(th);

      for(let s=0; s<S; s++){
        const td = document.createElement('td');
        const ass = state.assignments.find(a=>a.groupId===g.id && a.day===d && a.slot===s);
        if(ass){
          const t = teacherMap.get(ass.teacherId);
          const tName = t ? t.name : '';
          td.textContent = `${ass.branch}\n${tName}`;
        }else{
          td.textContent = '';
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    page.appendChild(table);

    const students = g.students || [];
    if(students.length){
      const div = document.createElement('div');
      div.className='students-2col';
      const ul = document.createElement('ul');
      students.forEach(st=>{
        const li = document.createElement('li');
        li.textContent = `${st.no} - ${st.name}`;
        ul.appendChild(li);
      });
      div.appendChild(ul);
      page.appendChild(div);
    }

    container.appendChild(page);
  });
}

function renderPrintByTeacher(container, filter){
  const D = state.program.days.length;
  const S = state.program.slots;
  const days = state.program.days;
  const labels = state.program.slotLabels.length ? state.program.slotLabels : Array.from({length:S},(_,i)=>(i+1)+'. Saat');

  const teachers = state.teachers.filter(t=>{
    const has = state.assignments.some(a=>a.teacherId===t.id);
    if(!has) return false;
    if(filter!=='all' && filter!==t.id) return false;
    return true;
  });

  if(!teachers.length){
    container.innerHTML = '<p class="muted">Seçilen filtreye göre atama yok.</p>';
    return;
  }

  teachers.forEach(t=>{
    const page = document.createElement('section');
    page.className='print-page avoid-break';

    const h = document.createElement('div');
    h.className='print-header';
    h.textContent = `Öğretmen: ${t.name} (${t.branch})`;
    const sub = document.createElement('div');
    sub.className='print-sub';
    sub.textContent = `${D} gün x ${S} slot`;
    page.appendChild(h);
    page.appendChild(sub);

    const table = document.createElement('table');
    table.className='print-table tight';
    const thead = document.createElement('thead');
    let tr = document.createElement('tr');
    tr.innerHTML = '<th>Gün / Saat</th>' + labels.map(l=>`<th>${escapeHtml(l)}</th>`).join('');
    thead.appendChild(tr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    for(let d=0; d<D; d++){
      tr = document.createElement('tr');
      const th = document.createElement('th');
      th.textContent = days[d];
      tr.appendChild(th);

      for(let s=0; s<S; s++){
        const td = document.createElement('td');
        const ass = state.assignments.find(a=>a.teacherId===t.id && a.day===d && a.slot===s);
        if(ass){
          const g = state.groups[ass.groupId];
          const gName = g ? g.name : ass.groupId;
          td.textContent = `${ass.branch}\n${gName}`;
        }else{
          td.textContent = '';
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    page.appendChild(table);

    container.appendChild(page);
  });
}

/* ===== Kaydet / Yükle ===== */
function saveAll(){
  try{
    const payload = JSON.stringify(state);
    localStorage.setItem(LS_KEY, payload);
    alert('Tüm veriler tarayıcıya kaydedildi.');
  }catch(err){
    alert('Kaydedilemedi: '+err.message);
  }
}

function loadAll(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){
      alert('Kayıt bulunamadı.');
      return;
    }
    const data = JSON.parse(raw);
    Object.assign(state, data || {});
    // UI senkronizasyon
    $('#daysInput').value  = (state.program.days||[]).join(',');
    $('#slotsInput').value = state.program.slots || 8;

    renderTeachers();
    renderStudents();
    buildGroupsFromStudents();
    renderGroupSummary();
    ensureSlotLabels();
    buildProgramGrid();
    ensureAvailabilityStructures();
    ensureRequests();
    renderAvailGrids();
    refreshReqFilterOptions();
    renderRequests();
    renderBranchChipsSummary();
    renderAssignCards();
    refreshPrintFilters();
    renderPrintPreview();

    alert('Veriler yüklendi.');
  }catch(err){
    alert('Yüklenemedi: '+err.message);
  }
}

/* ===== Init ve Eventler ===== */
function init(){
  bindTopTabs();

  // Step1
  $('#btnFetch').addEventListener('click', fetchAll);
  $('#btnClear').addEventListener('click', ()=>{
    if(confirm('Tüm veriler temizlensin mi?')) clearAll();
  });
  $('#goto2').addEventListener('click', ()=> showTopTab('step2'));

  // Step2
  $('#btnBuildGrid').addEventListener('click', ()=>{
    const oldD = state.program.days.length;
    const oldS = state.program.slots;
    buildProgramFromInputs();
    const changed = oldD!==state.program.days.length || oldS!==state.program.slots;
    if(changed){
      reconcileAllToProgram(getAssignPolicy());
      ensureAvailabilityStructures();
    }
    buildProgramGrid();
  });
  $('#btnProgExport').addEventListener('click', ()=> download('program.json', state.program));
  $('#btnProgImport').addEventListener('click', ()=>{
    openFile($('#fileProgImport'), obj=>{
      state.program = obj || state.program;
      $('#daysInput').value  = (state.program.days||[]).join(',');
      $('#slotsInput').value = state.program.slots || 8;
      ensureSlotLabels();
      reconcileAllToProgram(getAssignPolicy());
      buildProgramGrid();
      renderAvailGrids();
      renderAssignCards();
      refreshPrintFilters();
      renderPrintPreview();
    });
  });
  $('#goto3').addEventListener('click', ()=> showTopTab('step3'));

  // Step3 – alt sekmeler
  $('#tabTeach').addEventListener('click', ()=>{
    $('#tabTeach').setAttribute('aria-selected','true');
    $('#tabGroup').setAttribute('aria-selected','false');
    $('#panelTeach').hidden = false;
    $('#panelGroup').hidden = true;
  });
  $('#tabGroup').addEventListener('click', ()=>{
    $('#tabTeach').setAttribute('aria-selected','false');
    $('#tabGroup').setAttribute('aria-selected','true');
    $('#panelTeach').hidden = true;
    $('#panelGroup').hidden = false;
  });

  $('#btnAvailExport').addEventListener('click', ()=> download('musaitlikler.json', state.availability));
  $('#btnAvailExport2').addEventListener('click', ()=> download('musaitlikler.json', state.availability));
  $('#btnAvailImport').addEventListener('click', ()=>{
    openFile($('#fileAvailImport'), obj=>{
      state.availability = obj || state.availability;
      ensureAvailabilityStructures();
      renderAvailGrids();
    });
  });
  $('#btnAvailImport2').addEventListener('click', ()=>{
    openFile($('#fileAvailImport2'), obj=>{
      state.availability = obj || state.availability;
      ensureAvailabilityStructures();
      renderAvailGrids();
    });
  });
  $('#btnAvailClear').addEventListener('click', ()=>{
    if(!confirm('Tüm öğretmen/grup müsaitlikleri silinsin mi?')) return;
    state.availability = {teachers:{},groups:{}};
    ensureAvailabilityStructures();
    renderAvailGrids();
  });
  $('#goto4').addEventListener('click', ()=> showTopTab('step4'));

  // Step4
  $('#reqGroupSelect').addEventListener('change', ()=> renderRequests());
  $('#btnReqExport').addEventListener('click', ()=> download('talepler.json', state.requests));
  $('#btnReqImport').addEventListener('click', ()=>{
    openFile($('#fileReqImport'), obj=>{
      state.requests = obj || {};
      ensureRequests();
      refreshReqFilterOptions();
      renderRequests();
      renderBranchChipsSummary();
    });
  });
  $('#btnReqClear').addEventListener('click', ()=>{
    if(!confirm('Tüm grup talepleri sıfırlansın mı?')) return;
    state.requests = {};
    ensureRequests();
    renderRequests();
    renderBranchChipsSummary();
  });
  $('#goto5').addEventListener('click', ()=> showTopTab('step5'));

  // Step5
  $('#btnAutoAssign').addEventListener('click', autoAssign);
  $('#btnAssgnExport').addEventListener('click', ()=> download('atamalar.json', state.assignments));
  $('#btnAssgnImport').addEventListener('click', ()=>{
    openFile($('#fileAssgnImport'), obj=>{
      state.assignments = obj || [];
      renderAssignCards();
      refreshPrintFilters();
      renderPrintPreview();
    });
  });
  $('#btnAssgnClear').addEventListener('click', ()=>{
    if(!confirm('Tüm atamalar silinsin mi?')) return;
    state.assignments = [];
    renderAssignCards();
    refreshPrintFilters();
    renderPrintPreview();
  });
  $('#goto6').addEventListener('click', ()=> showTopTab('step6'));

  // Manuel atama dialog butonları
  $('#dlgCancel').addEventListener('click', e=>{ e.preventDefault(); closeAssignDialog(); });
  $('#dlgDelete').addEventListener('click', e=>{ e.preventDefault(); deleteAssignmentFromDialog(); });
  $('#dlgOk').addEventListener('click', e=>{ e.preventDefault(); saveAssignmentFromDialog(); });

  // Step6
  $('#printMode').addEventListener('change', ()=>{
    refreshPrintFilters();
    renderPrintPreview();
  });
  $('#printFilter').addEventListener('change', ()=> renderPrintPreview());
  $('#btnRenderPrint').addEventListener('click', ()=> renderPrintPreview());

  // Kaydet/Yükle
  $('#btnSaveAll').addEventListener('click', saveAll);
  $('#btnLoadAll').addEventListener('click', loadAll);

  // Program inputlarını state ile senkronla
  $('#daysInput').value  = (state.program.days||[]).join(',');
  $('#slotsInput').value = state.program.slots || 8;
  ensureSlotLabels();
  buildProgramGrid();
  ensureAvailabilityStructures();
  renderAvailGrids();
  ensureRequests();
  refreshReqFilterOptions();
  renderRequests();
  renderBranchChipsSummary();
  renderAssignCards();
  refreshPrintFilters();
  renderPrintPreview();

  // İSTEK 1: Sayfa açılır açılmaz verileri oku (bir kerelik, sheet ID doluysa)
  const sid = $('#sheetId').value.trim();
  if(sid && !autoFetchDone){
    autoFetchDone = true;
    fetchAll();
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
